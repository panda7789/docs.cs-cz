---
title: Nastavení prostředí profilace
ms.date: 03/30/2017
helpviewer_keywords:
- environment variables, profiling API
- profiling API [.NET Framework], setting up environment
- COR_PROFILER environment variable
- Windows Service applications, profiling
- profiling API [.NET Framework], Windows Service applications
- COR_ENABLE_PROFILING environment variable
- profiling API [.NET Framework], enabling
ms.assetid: fefca07f-7555-4e77-be86-3c542e928312
ms.openlocfilehash: 04b9abd8ffe04a24c08ad89ff48b037c9b003359
ms.sourcegitcommit: b11efd71c3d5ce3d9449c8d4345481b9f21392c6
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 01/29/2020
ms.locfileid: "76860976"
---
# <a name="setting-up-a-profiling-environment"></a><span data-ttu-id="482c7-102">Nastavení prostředí profilace</span><span class="sxs-lookup"><span data-stu-id="482c7-102">Setting Up a Profiling Environment</span></span>
> [!NOTE]
> <span data-ttu-id="482c7-103">V .NET Framework 4 byly zásadní změny profilace.</span><span class="sxs-lookup"><span data-stu-id="482c7-103">There have been substantial changes to profiling in the .NET Framework 4.</span></span>  
  
 <span data-ttu-id="482c7-104">Při spuštění spravovaného procesu (aplikace nebo služby) načte modul CLR (Common Language Runtime).</span><span class="sxs-lookup"><span data-stu-id="482c7-104">When a managed process (application or service) starts, it loads the common language runtime (CLR).</span></span> <span data-ttu-id="482c7-105">Při inicializaci modulu CLR vyhodnotí následující dvě proměnné prostředí k rozhodnutí, zda se má proces připojit k profileru:</span><span class="sxs-lookup"><span data-stu-id="482c7-105">When the CLR is initialized, it evaluates the following two environmental variables to decide whether the process should connect to a profiler:</span></span>  
  
- <span data-ttu-id="482c7-106">COR_ENABLE_PROFILING: CLR se připojí k profileru jenom v případě, že tato proměnná prostředí existuje a je nastavená na 1.</span><span class="sxs-lookup"><span data-stu-id="482c7-106">COR_ENABLE_PROFILING: The CLR connects to a profiler only if this environment variable exists and is set to 1.</span></span>  
  
- <span data-ttu-id="482c7-107">COR_PROFILER: Pokud COR_ENABLE_PROFILING projde, CLR se připojí k profileru, který má tento identifikátor CLSID nebo ProgID, který musí být uložen dříve v registru.</span><span class="sxs-lookup"><span data-stu-id="482c7-107">COR_PROFILER: If the COR_ENABLE_PROFILING check passes, the CLR connects to the profiler that has this CLSID or ProgID, which must have been stored previously in the registry.</span></span> <span data-ttu-id="482c7-108">Proměnná prostředí COR_PROFILER je definována jako řetězec, jak je znázorněno v následujících dvou příkladech.</span><span class="sxs-lookup"><span data-stu-id="482c7-108">The COR_PROFILER environment variable is defined as a string, as shown in the following two examples.</span></span>  
  
    ```cpp  
    set COR_PROFILER={32E2F4DA-1BEA-47ea-88F9-C5DAF691C94A}  
    set COR_PROFILER="MyProfiler"  
    ```  
  
 <span data-ttu-id="482c7-109">Chcete-li profilovat aplikaci CLR, je nutné před spuštěním aplikace nastavit proměnné prostředí COR_ENABLE_PROFILING a COR_PROFILER.</span><span class="sxs-lookup"><span data-stu-id="482c7-109">To profile a CLR application, you must set the COR_ENABLE_PROFILING and COR_PROFILER environment variables before you run the application.</span></span> <span data-ttu-id="482c7-110">Musíte se také ujistit, že je knihovna DLL profileru zaregistrovaná.</span><span class="sxs-lookup"><span data-stu-id="482c7-110">You must also make sure that the profiler DLL is registered.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="482c7-111">Od .NET Framework 4 se profilery nemusí registrovat.</span><span class="sxs-lookup"><span data-stu-id="482c7-111">Starting with the .NET Framework 4, profilers do not have to be registered.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="482c7-112">Chcete-li použít .NET Framework verze 2,0, 3,0 a 3,5 profilery v .NET Framework 4 a novějších verzích, je nutné nastavit proměnnou prostředí COMPLUS_ProfAPI_ProfilerCompatibilitySetting.</span><span class="sxs-lookup"><span data-stu-id="482c7-112">To use .NET Framework versions 2.0, 3.0, and 3.5 profilers in the .NET Framework 4 and later versions, you must set the COMPLUS_ProfAPI_ProfilerCompatibilitySetting environment variable.</span></span>  
  
## <a name="environment-variable-scope"></a><span data-ttu-id="482c7-113">Rozsah proměnné prostředí</span><span class="sxs-lookup"><span data-stu-id="482c7-113">Environment Variable Scope</span></span>  
 <span data-ttu-id="482c7-114">Způsob nastavení COR_ENABLE_PROFILING a proměnné prostředí COR_PROFILER určují jejich rozsah vlivu.</span><span class="sxs-lookup"><span data-stu-id="482c7-114">How you set the COR_ENABLE_PROFILING and COR_PROFILER environment variables will determine their scope of influence.</span></span> <span data-ttu-id="482c7-115">Tyto proměnné můžete nastavit jedním z následujících způsobů:</span><span class="sxs-lookup"><span data-stu-id="482c7-115">You can set these variables in one of the following ways:</span></span>  
  
- <span data-ttu-id="482c7-116">Pokud jste nastavili proměnné v volání [ICorDebug:: CreateProcess](../../../../docs/framework/unmanaged-api/debugging/icordebug-createprocess-method.md) , budou se vztahovat jenom na aplikaci, kterou používáte v daném okamžiku.</span><span class="sxs-lookup"><span data-stu-id="482c7-116">If you set the variables in an [ICorDebug::CreateProcess](../../../../docs/framework/unmanaged-api/debugging/icordebug-createprocess-method.md) call, they will apply only to the application that you are running at the time.</span></span> <span data-ttu-id="482c7-117">(Budou platit také pro ostatní aplikace spuštěné aplikací, které dědí prostředí.)</span><span class="sxs-lookup"><span data-stu-id="482c7-117">(They will also apply to other applications started by that application that inherit the environment.)</span></span>  
  
- <span data-ttu-id="482c7-118">Pokud jste nastavili proměnné v okně příkazového řádku, budou platit pro všechny aplikace, které jsou spuštěny z tohoto okna.</span><span class="sxs-lookup"><span data-stu-id="482c7-118">If you set the variables in a Command Prompt window, they will apply to all applications that are started from that window.</span></span>  
  
- <span data-ttu-id="482c7-119">Pokud jste nastavili proměnné na úrovni uživatele, použijí se na všechny aplikace, které spustíte v Průzkumníkovi souborů.</span><span class="sxs-lookup"><span data-stu-id="482c7-119">If you set the variables at the user level, they will apply to all applications that you start with File Explorer.</span></span> <span data-ttu-id="482c7-120">Okno příkazového řádku, které otevřete po nastavení proměnných, bude mít tato nastavení prostředí, a takže bude mít všechny aplikace spouštěné z tohoto okna.</span><span class="sxs-lookup"><span data-stu-id="482c7-120">A Command Prompt window that you open after you set the variables will have these environment settings, and so will any application that you start from that window.</span></span> <span data-ttu-id="482c7-121">Chcete-li nastavit proměnné prostředí na úrovni uživatele, klikněte pravým tlačítkem myši na položku **Tento počítač**, klikněte na příkaz **vlastnosti**, klikněte na kartu **Upřesnit** , klikněte na položku **proměnné prostředí**a přidejte proměnné do seznamu **uživatelské proměnné** .</span><span class="sxs-lookup"><span data-stu-id="482c7-121">To set environment variables at the user level, right-click **My Computer**, click **Properties**, click the **Advanced** tab, click **Environment Variables**, and add the variables to the **User variables** list.</span></span>  
  
- <span data-ttu-id="482c7-122">Pokud jste nastavili proměnné na úrovni počítače, budou platit pro všechny aplikace, které jsou na tomto počítači spuštěné.</span><span class="sxs-lookup"><span data-stu-id="482c7-122">If you set the variables at the computer level, they will apply to all applications that are started on that computer.</span></span> <span data-ttu-id="482c7-123">Okno příkazového řádku, které otevřete na tomto počítači, bude mít tato nastavení prostředí, a takže bude mít všechny aplikace, které z tohoto okna spustíte.</span><span class="sxs-lookup"><span data-stu-id="482c7-123">A Command Prompt window that you open on that computer will have these environment settings, and so will any application that you start from that window.</span></span> <span data-ttu-id="482c7-124">To znamená, že všechny spravované procesy v tomto počítači budou začínat vaším profilerem.</span><span class="sxs-lookup"><span data-stu-id="482c7-124">This means that every managed process on that computer will start with your profiler.</span></span> <span data-ttu-id="482c7-125">Chcete-li nastavit proměnné prostředí na úrovni počítače, klikněte pravým tlačítkem myši na položku **Tento počítač**, klikněte na příkaz **vlastnosti**, klikněte na kartu **Upřesnit** , klikněte na položku **proměnné prostředí**, přidejte proměnné do seznamu **systémové proměnné** a pak restartujte počítač.</span><span class="sxs-lookup"><span data-stu-id="482c7-125">To set environment variables at the computer level, right-click **My Computer**, click **Properties**, click the **Advanced** tab, click **Environment Variables**, add the variables to the **System variables** list, and then restart your computer.</span></span> <span data-ttu-id="482c7-126">Po restartování budou proměnné dostupné v rámci systému.</span><span class="sxs-lookup"><span data-stu-id="482c7-126">After restarting, the variables will be available system-wide.</span></span>  
  
 <span data-ttu-id="482c7-127">Pokud vytváříte profilaci služby systému Windows, musíte restartovat počítač po nastavení proměnných prostředí a registraci knihovny DLL profileru.</span><span class="sxs-lookup"><span data-stu-id="482c7-127">If you are profiling a Windows Service, you must restart your computer after you set the environment variables and register the profiler DLL.</span></span> <span data-ttu-id="482c7-128">Další informace o těchto doporučeních najdete v části [profilování služby systému Windows](#windows_service).</span><span class="sxs-lookup"><span data-stu-id="482c7-128">For more information about these considerations, see the section [Profiling a Windows Service](#windows_service).</span></span>  
  
## <a name="additional-considerations"></a><span data-ttu-id="482c7-129">Další požadavky</span><span class="sxs-lookup"><span data-stu-id="482c7-129">Additional Considerations</span></span>  
  
- <span data-ttu-id="482c7-130">Třída profileru implementuje rozhraní [ICorProfilerCallback](icorprofilercallback-interface.md) a [ICorProfilerCallback2](icorprofilercallback2-interface.md) .</span><span class="sxs-lookup"><span data-stu-id="482c7-130">The profiler class implements the [ICorProfilerCallback](icorprofilercallback-interface.md) and [ICorProfilerCallback2](icorprofilercallback2-interface.md) interfaces.</span></span> <span data-ttu-id="482c7-131">V .NET Framework verze 2,0 musí Profiler implementovat `ICorProfilerCallback2`.</span><span class="sxs-lookup"><span data-stu-id="482c7-131">In the .NET Framework version 2.0, a profiler must implement `ICorProfilerCallback2`.</span></span> <span data-ttu-id="482c7-132">Pokud tomu tak není, `ICorProfilerCallback2` nebudou načteny.</span><span class="sxs-lookup"><span data-stu-id="482c7-132">If it does not, `ICorProfilerCallback2` will not be loaded.</span></span>  
  
- <span data-ttu-id="482c7-133">Pouze jeden profiler může profilovat proces v jednom okamžiku v daném prostředí.</span><span class="sxs-lookup"><span data-stu-id="482c7-133">Only one profiler can profile a process at one time in a given environment.</span></span> <span data-ttu-id="482c7-134">V různých prostředích můžete registrovat dva různé profilery, ale každý musí profilovat samostatné procesy.</span><span class="sxs-lookup"><span data-stu-id="482c7-134">You can register two different profilers in different environments, but each must profile separate processes.</span></span> <span data-ttu-id="482c7-135">Profiler se musí implementovat jako vnitroprocesové knihovna DLL COM serveru, která je namapovaná do stejného adresního prostoru jako proces, který se profiluje.</span><span class="sxs-lookup"><span data-stu-id="482c7-135">The profiler must be implemented as an in-process COM server DLL, which is mapped into the same address space as the process that is being profiled.</span></span> <span data-ttu-id="482c7-136">To znamená, že Profiler běží vnitroprocesově.</span><span class="sxs-lookup"><span data-stu-id="482c7-136">This means that the profiler runs in-process.</span></span> <span data-ttu-id="482c7-137">.NET Framework nepodporuje žádný jiný typ serveru COM.</span><span class="sxs-lookup"><span data-stu-id="482c7-137">The .NET Framework does not support any other type of COM server.</span></span> <span data-ttu-id="482c7-138">Pokud profiler chce například monitorovat aplikace ze vzdáleného počítače, musí implementovat agenty kolektoru na každém počítači.</span><span class="sxs-lookup"><span data-stu-id="482c7-138">For example, if a profiler wants to monitor applications from a remote computer, it must implement collector agents on each computer.</span></span> <span data-ttu-id="482c7-139">Tito agenti budou mít za následek dávkování výsledků a oznámí je centrálnímu počítači pro shromažďování dat.</span><span class="sxs-lookup"><span data-stu-id="482c7-139">These agents will batch results and communicate them to the central data collection computer.</span></span>  
  
- <span data-ttu-id="482c7-140">Vzhledem k tomu, že Profiler je objekt modelu COM, který je vytvořen v procesu, každá profilovaná aplikace bude mít svou vlastní kopii profileru.</span><span class="sxs-lookup"><span data-stu-id="482c7-140">Because the profiler is a COM object that is instantiated in-process, each profiled application will have its own copy of the profiler.</span></span> <span data-ttu-id="482c7-141">Proto jedna instance profileru nemusí zpracovávat data z více aplikací.</span><span class="sxs-lookup"><span data-stu-id="482c7-141">Therefore, a single profiler instance does not have to handle data from multiple applications.</span></span> <span data-ttu-id="482c7-142">Budete však muset přidat logiku k kódu protokolování profileru, abyste zabránili přepsání souboru protokolu z jiných profilových aplikací.</span><span class="sxs-lookup"><span data-stu-id="482c7-142">However, you will have to add logic to the profiler's logging code to prevent log file overwrites from other profiled applications.</span></span>  
  
## <a name="initializing-the-profiler"></a><span data-ttu-id="482c7-143">Inicializuje se Profiler.</span><span class="sxs-lookup"><span data-stu-id="482c7-143">Initializing the Profiler</span></span>  
 <span data-ttu-id="482c7-144">Když obě kontroly proměnné prostředí přejdou, vytvoří CLR instanci profileru podobným způsobem jako funkce `CoCreateInstance` COM.</span><span class="sxs-lookup"><span data-stu-id="482c7-144">When both environment variable checks pass, the CLR creates an instance of the profiler in a similar manner to the COM `CoCreateInstance` function.</span></span> <span data-ttu-id="482c7-145">Profiler není načten prostřednictvím přímého volání `CoCreateInstance`.</span><span class="sxs-lookup"><span data-stu-id="482c7-145">The profiler is not loaded through a direct call to `CoCreateInstance`.</span></span> <span data-ttu-id="482c7-146">Proto volání `CoInitialize`, které vyžaduje nastavení modelu vláken, se vyhne.</span><span class="sxs-lookup"><span data-stu-id="482c7-146">Therefore, a call to `CoInitialize`, which requires setting the threading model, is avoided.</span></span> <span data-ttu-id="482c7-147">Modul CLR pak zavolá metodu [ICorProfilerCallback:: Initialize](icorprofilercallback-initialize-method.md) v profileru.</span><span class="sxs-lookup"><span data-stu-id="482c7-147">The CLR then calls the [ICorProfilerCallback::Initialize](icorprofilercallback-initialize-method.md) method in the profiler.</span></span> <span data-ttu-id="482c7-148">Signatura této metody je následující.</span><span class="sxs-lookup"><span data-stu-id="482c7-148">The signature of this method is as follows.</span></span>  
  
```cpp  
HRESULT Initialize(IUnknown *pICorProfilerInfoUnk)  
```  
  
 <span data-ttu-id="482c7-149">Profiler musí zadat dotaz na `pICorProfilerInfoUnk` pro ukazatel rozhraní [ICorProfilerInfo](icorprofilerinfo-interface.md) nebo [ICorProfilerInfo2](icorprofilerinfo2-interface.md) a uložit ho tak, aby si mohl vyžádat další informace později během profilace.</span><span class="sxs-lookup"><span data-stu-id="482c7-149">The profiler must query `pICorProfilerInfoUnk` for an [ICorProfilerInfo](icorprofilerinfo-interface.md) or [ICorProfilerInfo2](icorprofilerinfo2-interface.md) interface pointer and save it so that it can request more information later during profiling.</span></span>  
  
## <a name="setting-event-notifications"></a><span data-ttu-id="482c7-150">Nastavení oznámení událostí</span><span class="sxs-lookup"><span data-stu-id="482c7-150">Setting Event Notifications</span></span>  
 <span data-ttu-id="482c7-151">Profiler pak zavolá metodu [ICorProfilerInfo:: SetEventMask](icorprofilerinfo-seteventmask-method.md) k určení kategorií oznámení, která vás zajímá.</span><span class="sxs-lookup"><span data-stu-id="482c7-151">The profiler then calls the [ICorProfilerInfo::SetEventMask](icorprofilerinfo-seteventmask-method.md) method to specify which categories of notifications it is interested in.</span></span> <span data-ttu-id="482c7-152">Například pokud má Profiler zajímat pouze oznámení o vstupu a opuštění funkce a oznámení o uvolňování paměti, určuje následující.</span><span class="sxs-lookup"><span data-stu-id="482c7-152">For example, if the profiler is interested only in function enter and leave notifications and garbage collection notifications, it specifies the following.</span></span>  
  
```cpp  
ICorProfilerInfo* pInfo;  
pICorProfilerInfoUnk->QueryInterface(IID_ICorProfilerInfo, (void**)&pInfo);  
pInfo->SetEventMask(COR_PRF_MONITOR_ENTERLEAVE | COR_PRF_MONITOR_GC)  
```  
  
 <span data-ttu-id="482c7-153">Nastavením masky oznámení tímto způsobem může Profiler omezit, která oznámení obdrží.</span><span class="sxs-lookup"><span data-stu-id="482c7-153">By setting the notifications mask in this manner, the profiler can limit which notifications it receives.</span></span> <span data-ttu-id="482c7-154">Tento přístup pomáhá uživateli vytvořit jednoduchý Profiler nebo profil pro speciální účely.</span><span class="sxs-lookup"><span data-stu-id="482c7-154">This approach helps the user build a simple or special-purpose profiler.</span></span> <span data-ttu-id="482c7-155">Zároveň se tím zkrátí čas procesoru, který by využíval zasílání oznámení o tom, že Profiler bude jenom ignorovat.</span><span class="sxs-lookup"><span data-stu-id="482c7-155">It also reduces CPU time that would be wasted sending notifications that the profiler would just ignore.</span></span>  
  
 <span data-ttu-id="482c7-156">Některé události profileru jsou neměnné.</span><span class="sxs-lookup"><span data-stu-id="482c7-156">Certain profiler events are immutable.</span></span> <span data-ttu-id="482c7-157">To znamená, že jakmile budou tyto události nastaveny ve `ICorProfilerCallback::Initialize` zpětného volání, nelze je vypnout a nové události nelze zapnout.</span><span class="sxs-lookup"><span data-stu-id="482c7-157">This means that as soon as these events are set in the `ICorProfilerCallback::Initialize` callback, they cannot be turned off and new events cannot be turned on.</span></span> <span data-ttu-id="482c7-158">Pokusy o změnu neměnných událostí budou mít za následek `ICorProfilerInfo::SetEventMask` vrácení neúspěšného HRESULT.</span><span class="sxs-lookup"><span data-stu-id="482c7-158">Attempts to change an immutable event will result in `ICorProfilerInfo::SetEventMask` returning a failed HRESULT.</span></span>  
  
<a name="windows_service"></a>   
## <a name="profiling-a-windows-service"></a><span data-ttu-id="482c7-159">Profilace služby systému Windows</span><span class="sxs-lookup"><span data-stu-id="482c7-159">Profiling a Windows Service</span></span>  
 <span data-ttu-id="482c7-160">Profilování služby systému Windows je jako profilace aplikace modulu CLR (Common Language Runtime).</span><span class="sxs-lookup"><span data-stu-id="482c7-160">Profiling a Windows Service is like profiling a common language runtime application.</span></span> <span data-ttu-id="482c7-161">Operace profilování jsou povolené prostřednictvím proměnných prostředí.</span><span class="sxs-lookup"><span data-stu-id="482c7-161">Both profiling operations are enabled through environment variables.</span></span> <span data-ttu-id="482c7-162">Vzhledem k tomu, že je spuštěna služba systému Windows při spuštění operačního systému, proměnné prostředí popsané dříve v tomto tématu již musí být přítomny a nastaveny na požadované hodnoty před spuštěním systému.</span><span class="sxs-lookup"><span data-stu-id="482c7-162">Because a Windows Service is started when the operating system starts, the environment variables discussed previously in this topic must already be present and set to the required values before the system starts.</span></span> <span data-ttu-id="482c7-163">Kromě toho musí být profilace DLL již v systému registrována.</span><span class="sxs-lookup"><span data-stu-id="482c7-163">In addition, the profiling DLL must already be registered on the system.</span></span>  
  
 <span data-ttu-id="482c7-164">Po nastavení proměnných prostředí COR_ENABLE_PROFILING a COR_PROFILER a registraci knihovny DLL profileru byste měli cílový počítač restartovat, aby služba systému Windows mohla tyto změny detekovat.</span><span class="sxs-lookup"><span data-stu-id="482c7-164">After you set the COR_ENABLE_PROFILING and COR_PROFILER environment variables and register the profiler DLL, you should restart the target computer so that the Windows Service can detect those changes.</span></span>  
  
 <span data-ttu-id="482c7-165">Všimněte si, že tyto změny umožní profilaci na úrovni systému.</span><span class="sxs-lookup"><span data-stu-id="482c7-165">Note that these changes will enable profiling on a system-wide basis.</span></span> <span data-ttu-id="482c7-166">Chcete-li zabránit každé spravované aplikaci, která je následně spouštěna profilování, měli byste po restartování cílového počítače odstranit proměnné prostředí systému.</span><span class="sxs-lookup"><span data-stu-id="482c7-166">To prevent every managed application that subsequently runs from being profiled, you should delete the system environment variables after you restart the target computer.</span></span>  
  
 <span data-ttu-id="482c7-167">Tato technika také vede ke každému procesu CLR s profilací.</span><span class="sxs-lookup"><span data-stu-id="482c7-167">This technique also leads to every CLR process getting profiled.</span></span> <span data-ttu-id="482c7-168">Profiler by měl přidat logiku do svého [ICorProfilerCallback:: Initialize](icorprofilercallback-initialize-method.md) zpětného volání pro zjištění, zda je aktuální proces důležité.</span><span class="sxs-lookup"><span data-stu-id="482c7-168">The profiler should add logic to its [ICorProfilerCallback::Initialize](icorprofilercallback-initialize-method.md) callback to detect whether the current process is of interest.</span></span> <span data-ttu-id="482c7-169">V opačném případě může Profiler selhání zpětného volání bez provedení inicializace.</span><span class="sxs-lookup"><span data-stu-id="482c7-169">If it is not, the profiler can fail the callback without performing the initialization.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="482c7-170">Viz také:</span><span class="sxs-lookup"><span data-stu-id="482c7-170">See also</span></span>

- [<span data-ttu-id="482c7-171">Přehled profilace</span><span class="sxs-lookup"><span data-stu-id="482c7-171">Profiling Overview</span></span>](profiling-overview.md)
