---
title: Izolace snímků na SQL serveru
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 43ae5dd3-50f5-43a8-8d01-e37a61664176
ms.openlocfilehash: 52c5dba1a21b0e8d8e5af1dc159941e5f4b4aa5f
ms.sourcegitcommit: a885cc8c3e444ca6471348893d5373c6e9e49a47
ms.translationtype: HT
ms.contentlocale: cs-CZ
ms.lasthandoff: 09/06/2018
ms.locfileid: "43879702"
---
# <a name="snapshot-isolation-in-sql-server"></a><span data-ttu-id="207b6-102">Izolace snímků na SQL serveru</span><span class="sxs-lookup"><span data-stu-id="207b6-102">Snapshot Isolation in SQL Server</span></span>
<span data-ttu-id="207b6-103">Izolace snímku vylepšuje souběžnosti pro aplikace s online zpracováním transakcí.</span><span class="sxs-lookup"><span data-stu-id="207b6-103">Snapshot isolation enhances concurrency for OLTP applications.</span></span>  
  
## <a name="understanding-snapshot-isolation-and-row-versioning"></a><span data-ttu-id="207b6-104">Principy izolaci snímku a správy verzí řádku</span><span class="sxs-lookup"><span data-stu-id="207b6-104">Understanding Snapshot Isolation and Row Versioning</span></span>  
 <span data-ttu-id="207b6-105">Jakmile je povolena izolace snímku, verze aktualizovaný řádek pro každou transakci jsou zachována ve **tempdb**.</span><span class="sxs-lookup"><span data-stu-id="207b6-105">Once snapshot isolation is enabled, updated row versions for each transaction are maintained in **tempdb**.</span></span> <span data-ttu-id="207b6-106">Pořadové číslo jedinečný transakce identifikuje každou transakci a Tato jedinečná čísla jsou zaznamenány pro každou verzi řádku.</span><span class="sxs-lookup"><span data-stu-id="207b6-106">A unique transaction sequence number identifies each transaction, and these unique numbers are recorded for each row version.</span></span> <span data-ttu-id="207b6-107">Transakce funguje s nejnovější verze řádků s pořadovým číslem než pořadové číslo transakce.</span><span class="sxs-lookup"><span data-stu-id="207b6-107">The transaction works with the most recent row versions having a sequence number before the sequence number of the transaction.</span></span> <span data-ttu-id="207b6-108">Novější verze řádků po zahájení transakce jsou ignorovány transakcí.</span><span class="sxs-lookup"><span data-stu-id="207b6-108">Newer row versions created after the transaction has begun are ignored by the transaction.</span></span>  
  
 <span data-ttu-id="207b6-109">Termín "snímku" odráží fakt, že všechny dotazy v transakci naleznete v tématu stejnou verzi nebo snímek databáze, na základě stavu databáze v okamžiku v čase zahájení transakce.</span><span class="sxs-lookup"><span data-stu-id="207b6-109">The term "snapshot" reflects the fact that all queries in the transaction see the same version, or snapshot, of the database, based on the state of the database at the moment in time when the transaction begins.</span></span> <span data-ttu-id="207b6-110">Žádné zámky pořízené na základní řádky dat nebo datových stránek v transakci snímku, která umožňuje ostatní transakce provést bez blokována předchozí nedokončené transakce.</span><span class="sxs-lookup"><span data-stu-id="207b6-110">No locks are acquired on the underlying data rows or data pages in a snapshot transaction, which permits other transactions to execute without being blocked by a prior uncompleted transaction.</span></span> <span data-ttu-id="207b6-111">Transakcí, které upravují data neblokují transakcí, které načítají data a transakcí, které načítají data neblokují transakcí, které budou zapisovat data, jako obvykle zadají v části výchozí úrovní izolace READ COMMITTED v systému SQL Server.</span><span class="sxs-lookup"><span data-stu-id="207b6-111">Transactions that modify data do not block transactions that read data, and transactions that read data do not block transactions that write data, as they normally would under the default READ COMMITTED isolation level in SQL Server.</span></span> <span data-ttu-id="207b6-112">Toto chování neblokující také významně snižuje pravděpodobnost, že zablokování pro složité transakce.</span><span class="sxs-lookup"><span data-stu-id="207b6-112">This non-blocking behavior also significantly reduces the likelihood of deadlocks for complex transactions.</span></span>  
  
 <span data-ttu-id="207b6-113">Izolace snímku používá model optimistického řízení souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="207b6-113">Snapshot isolation uses an optimistic concurrency model.</span></span> <span data-ttu-id="207b6-114">Pokud transakce snímku se pokusí o potvrzení změny dat, které se změnily od zahájení transakce, transakce se vrátit zpět a bude vyvolána k chybě.</span><span class="sxs-lookup"><span data-stu-id="207b6-114">If a snapshot transaction attempts to commit modifications to data that has changed since the transaction began, the transaction will roll back and an error will be raised.</span></span> <span data-ttu-id="207b6-115">Tomu lze zabránit pomocí UPDLOCK tipů pro příkazy SELECT, které přístup k datům, která má být upraven.</span><span class="sxs-lookup"><span data-stu-id="207b6-115">You can avoid this by using UPDLOCK hints for SELECT statements that access data to be modified.</span></span> <span data-ttu-id="207b6-116">Další informace naleznete v tématu "Pomocné parametry zámku" SQL Server Books Online.</span><span class="sxs-lookup"><span data-stu-id="207b6-116">See "Locking Hints" in SQL Server Books Online for more information.</span></span>  
  
 <span data-ttu-id="207b6-117">Nastavením je možnost databáze dále ALLOW_SNAPSHOT_ISOLATION předtím, než je použit v transakcích musí být povolena izolace snímku.</span><span class="sxs-lookup"><span data-stu-id="207b6-117">Snapshot isolation must be enabled by setting the ALLOW_SNAPSHOT_ISOLATION ON database option before it is used in transactions.</span></span> <span data-ttu-id="207b6-118">Tím dojde k aktivaci mechanismus pro ukládání verze řádků v dočasné databázi (**tempdb**).</span><span class="sxs-lookup"><span data-stu-id="207b6-118">This activates the mechanism for storing row versions in the temporary database (**tempdb**).</span></span> <span data-ttu-id="207b6-119">Je nutné povolit izolaci snímku v každé databázi, která používá s příkazem jazyka Transact-SQL ALTER DATABASE.</span><span class="sxs-lookup"><span data-stu-id="207b6-119">You must enable snapshot isolation in each database that uses it with the Transact-SQL ALTER DATABASE statement.</span></span> <span data-ttu-id="207b6-120">Izolace snímku se v tomto ohledu liší od úrovně tradiční izolace READ COMMITTED, REPEATABLE READ, SERIALIZABLE a READ UNCOMMITTED, které není potřeba konfigurovat.</span><span class="sxs-lookup"><span data-stu-id="207b6-120">In this respect, snapshot isolation differs from the traditional isolation levels of READ COMMITTED, REPEATABLE READ, SERIALIZABLE, and READ UNCOMMITTED, which require no configuration.</span></span> <span data-ttu-id="207b6-121">Následující příkazy aktivovat izolaci snímku a nahraďte výchozí chování READ COMMITTED SNAPSHOT:</span><span class="sxs-lookup"><span data-stu-id="207b6-121">The following statements activate snapshot isolation and replace the default READ COMMITTED behavior with SNAPSHOT:</span></span>  
  
```  
ALTER DATABASE MyDatabase  
SET ALLOW_SNAPSHOT_ISOLATION ON  
  
ALTER DATABASE MyDatabase  
SET READ_COMMITTED_SNAPSHOT ON  
```  
  
 <span data-ttu-id="207b6-122">Pod úrovní izolace READ COMMITTED výchozí nastavení možnost READ_COMMITTED_SNAPSHOT dále umožňuje přístup k řádkům.</span><span class="sxs-lookup"><span data-stu-id="207b6-122">Setting the READ_COMMITTED_SNAPSHOT ON option allows access to versioned rows under the default READ COMMITTED isolation level.</span></span> <span data-ttu-id="207b6-123">Pokud je možnost READ_COMMITTED_SNAPSHOT nastavena na hodnotu OFF, musíte explicitně nastavit úroveň izolace snímku pro každou relaci za účelem přístupu k řádkům.</span><span class="sxs-lookup"><span data-stu-id="207b6-123">If the READ_COMMITTED_SNAPSHOT option is set to OFF, you must explicitly set the Snapshot isolation level for each session in order to access versioned rows.</span></span>  
  
## <a name="managing-concurrency-with-isolation-levels"></a><span data-ttu-id="207b6-124">Správa souběžnosti s úrovní izolace</span><span class="sxs-lookup"><span data-stu-id="207b6-124">Managing Concurrency with Isolation Levels</span></span>  
 <span data-ttu-id="207b6-125">Úroveň izolace, pod kterým provádí příkaz jazyka Transact-SQL určuje jeho verzí chování zámku a řádek.</span><span class="sxs-lookup"><span data-stu-id="207b6-125">The isolation level under which a Transact-SQL statement executes determines its locking and row versioning behavior.</span></span> <span data-ttu-id="207b6-126">Úroveň izolace má připojení oboru a po nastavení připojení pomocí příkazu nastavte úroveň izolace transakce, zůstává v platnosti, dokud se připojení uzavře nebo nastavte jinou úroveň izolace.</span><span class="sxs-lookup"><span data-stu-id="207b6-126">An isolation level has connection-wide scope, and once set for a connection with the SET TRANSACTION ISOLATION LEVEL statement, it remains in effect until the connection is closed or another isolation level is set.</span></span> <span data-ttu-id="207b6-127">Při zavření připojení a vrácen do fondu se uchovávají úroveň izolace z posledního příkazu nastavte úroveň izolace transakce.</span><span class="sxs-lookup"><span data-stu-id="207b6-127">When a connection is closed and returned to the pool, the isolation level from the last SET TRANSACTION ISOLATION LEVEL statement is retained.</span></span> <span data-ttu-id="207b6-128">Další připojení, opětovné použití použití připojení z fondu, který je ve fondu úroveň izolace, která je v platnosti v době připojení.</span><span class="sxs-lookup"><span data-stu-id="207b6-128">Subsequent connections reusing a pooled connection use the isolation level that was in effect at the time the connection is pooled.</span></span>  
  
 <span data-ttu-id="207b6-129">Jednotlivé dotazy odeslané v rámci určitého připojení může obsahovat pomocné parametry zámku, která upravit izolaci pro jeden příkaz nebo transakce, ale nemají vliv na úroveň izolace připojení.</span><span class="sxs-lookup"><span data-stu-id="207b6-129">Individual queries issued within a connection can contain lock hints that modify the isolation for a single statement or transaction but do not affect the isolation level of the connection.</span></span> <span data-ttu-id="207b6-130">Úrovně izolace nebo pomocné parametry zámku nastavit uložené procedury nebo funkce neměňte úroveň izolace, která je volá připojení a jsou platné jenom po dobu trvání volání uložené procedury nebo funkce.</span><span class="sxs-lookup"><span data-stu-id="207b6-130">Isolation levels or lock hints set in stored procedures or functions do not change the isolation level of the connection that calls them and are in effect only for the duration of the stored procedure or function call.</span></span>  
  
 <span data-ttu-id="207b6-131">Čtyři úrovně izolace definované ve standardu SQL 92 byly podporované v dřívějších verzích systému SQL Server:</span><span class="sxs-lookup"><span data-stu-id="207b6-131">Four isolation levels defined in the SQL-92 standard were supported in early versions of SQL Server:</span></span>  
  
-   <span data-ttu-id="207b6-132">READ UNCOMMITTED se nejméně omezující úroveň izolace, protože ignoruje zámků jinými transakcemi.</span><span class="sxs-lookup"><span data-stu-id="207b6-132">READ UNCOMMITTED is the least restrictive isolation level because it ignores locks placed by other transactions.</span></span> <span data-ttu-id="207b6-133">Provádění v rámci čtení NEPOTVRZENÉ transakce může číst změny datových hodnot, které nebyly dosud byla potvrzena dalšími transakcemi; ty se nazývají "hrubé" čtení.</span><span class="sxs-lookup"><span data-stu-id="207b6-133">Transactions executing under READ UNCOMMITTED can read modified data values that have not yet been committed by other transactions; these are called "dirty" reads.</span></span>  
  
-   <span data-ttu-id="207b6-134">READ COMMITTED je výchozí úroveň izolace pro SQL Server.</span><span class="sxs-lookup"><span data-stu-id="207b6-134">READ COMMITTED is the default isolation level for SQL Server.</span></span> <span data-ttu-id="207b6-135">Ta brání nepřesné tak, že určíte, že příkazy nemůže číst hodnoty dat, které byla upravena, ale ještě nebyla potvrzena dalšími transakcemi.</span><span class="sxs-lookup"><span data-stu-id="207b6-135">It prevents dirty reads by specifying that statements cannot read data values that have been modified but not yet committed by other transactions.</span></span> <span data-ttu-id="207b6-136">Ostatní transakce stále můžete změnit, vložení nebo odstranění dat mezi spuštěními jednotlivé příkazy v rámci aktuální transakce, což vede k-opakovatelné operace čtení nebo "fiktivní" data.</span><span class="sxs-lookup"><span data-stu-id="207b6-136">Other transactions can still modify, insert, or delete data between executions of individual statements within the current transaction, resulting in non-repeatable reads, or "phantom" data.</span></span>  
  
-   <span data-ttu-id="207b6-137">REPEATABLE READ je více omezující úroveň izolace než READ COMMITTED.</span><span class="sxs-lookup"><span data-stu-id="207b6-137">REPEATABLE READ is a more restrictive isolation level than READ COMMITTED.</span></span> <span data-ttu-id="207b6-138">Zahrnuje potvrzené pro čtení a kromě toho určuje, že žádné další transakce můžete upravit nebo odstranit data, která byla načtena pomocí aktuální transakce dokud aktuální transakce potvrzena.</span><span class="sxs-lookup"><span data-stu-id="207b6-138">It encompasses READ COMMITTED and additionally specifies that no other transactions can modify or delete data that has been read by the current transaction until the current transaction commits.</span></span> <span data-ttu-id="207b6-139">Souběžnost je nižší než pro čtení potvrzené, protože sdílené na čtení dat zámky po dobu trvání transakce místo se vydávají na konci každého příkazu.</span><span class="sxs-lookup"><span data-stu-id="207b6-139">Concurrency is lower than for READ COMMITTED because shared locks on read data are held for the duration of the transaction instead of being released at the end of each statement.</span></span>  
  
-   <span data-ttu-id="207b6-140">SERIALIZOVATELNÝ je nejvíce omezující úroveň izolace, protože uzamkne celých rozsahů klíče a až do dokončení transakce obsahuje zámky.</span><span class="sxs-lookup"><span data-stu-id="207b6-140">SERIALIZABLE is the most restrictive isolation level, because it locks entire ranges of keys and holds the locks until the transaction is complete.</span></span> <span data-ttu-id="207b6-141">Zahrnuje OPAKOVATELNÉ čtení a přidá omezení, ostatní transakce nelze vložit nové řádky do oblastí, které byly načteny transakce až do dokončení transakce.</span><span class="sxs-lookup"><span data-stu-id="207b6-141">It encompasses REPEATABLE READ and adds the restriction that other transactions cannot insert new rows into ranges that have been read by the transaction until the transaction is complete.</span></span>  
  
 <span data-ttu-id="207b6-142">Další informace najdete v tématu "Úrovně izolace" SQL Server Books Online.</span><span class="sxs-lookup"><span data-stu-id="207b6-142">For more information, see "Isolation Levels" in SQL Server Books Online.</span></span>  
  
### <a name="snapshot-isolation-level-extensions"></a><span data-ttu-id="207b6-143">Rozšíření úrovni izolace snímku</span><span class="sxs-lookup"><span data-stu-id="207b6-143">Snapshot Isolation Level Extensions</span></span>  
 <span data-ttu-id="207b6-144">SQL Server zavádí rozšíření na úrovních izolace SQL 92 s po zavedení služby na úrovni izolace SNÍMKU a další provádění READ COMMITTED.</span><span class="sxs-lookup"><span data-stu-id="207b6-144">SQL Server introduced extensions to the SQL-92 isolation levels with the introduction of the SNAPSHOT isolation level and an additional implementation of READ COMMITTED.</span></span> <span data-ttu-id="207b6-145">Úroveň izolace READ_COMMITTED_SNAPSHOT můžete transparentně nahradit READ COMMITTED pro všechny transakce.</span><span class="sxs-lookup"><span data-stu-id="207b6-145">The READ_COMMITTED_SNAPSHOT isolation level can transparently replace READ COMMITTED for all transactions.</span></span>  
  
-   <span data-ttu-id="207b6-146">Izolace SNÍMKU Určuje, že data načtená v rámci transakce nikdy odrážejí změny provedené jinými souběžných transakcemi.</span><span class="sxs-lookup"><span data-stu-id="207b6-146">SNAPSHOT isolation specifies that data read within a transaction will never reflect changes made by other simultaneous transactions.</span></span> <span data-ttu-id="207b6-147">Transakce používá verze řádků dat, které existují při zahájení transakce.</span><span class="sxs-lookup"><span data-stu-id="207b6-147">The transaction uses the data row versions that exist when the transaction begins.</span></span> <span data-ttu-id="207b6-148">Žádné zámky jsou umístěny na data při je pro čtení, takže transakcí SNÍMKŮ neblokují ostatní transakce od vytváření dat.</span><span class="sxs-lookup"><span data-stu-id="207b6-148">No locks are placed on the data when it is read, so SNAPSHOT transactions do not block other transactions from writing data.</span></span> <span data-ttu-id="207b6-149">Transakcí, které zápis dat nedochází k blokování transakcí snímků z dat pro čtení.</span><span class="sxs-lookup"><span data-stu-id="207b6-149">Transactions that write data do not block snapshot transactions from reading data.</span></span> <span data-ttu-id="207b6-150">Je potřeba povolit izolaci snímku nastavením možnosti ALLOW_SNAPSHOT_ISOLATION databáze použít.</span><span class="sxs-lookup"><span data-stu-id="207b6-150">You need to enable snapshot isolation by setting the ALLOW_SNAPSHOT_ISOLATION database option in order to use it.</span></span>  
  
-   <span data-ttu-id="207b6-151">Možnost databáze READ_COMMITTED_SNAPSHOT určuje chování výchozí úroveň izolace READ COMMITTED, pokud je povolena izolace snímku v databázi.</span><span class="sxs-lookup"><span data-stu-id="207b6-151">The READ_COMMITTED_SNAPSHOT database option determines the behavior of the default READ COMMITTED isolation level when snapshot isolation is enabled in a database.</span></span> <span data-ttu-id="207b6-152">Pokud možnost READ_COMMITTED_SNAPSHOT ON není explicitně zadán, READ COMMITTED platí pro všechny implicitní transakce.</span><span class="sxs-lookup"><span data-stu-id="207b6-152">If you do not explicitly specify READ_COMMITTED_SNAPSHOT ON, READ COMMITTED is applied to all implicit transactions.</span></span> <span data-ttu-id="207b6-153">To vytváří stejné chování jako nastavení READ_COMMITTED_SNAPSHOT vypnuto (výchozí).</span><span class="sxs-lookup"><span data-stu-id="207b6-153">This produces the same behavior as setting READ_COMMITTED_SNAPSHOT OFF (the default).</span></span> <span data-ttu-id="207b6-154">Když READ_COMMITTED_SNAPSHOT vypnout je v platnosti, databázový stroj používá sdílené uzamčení k vynucení výchozí úroveň izolace.</span><span class="sxs-lookup"><span data-stu-id="207b6-154">When READ_COMMITTED_SNAPSHOT OFF is in effect, the Database Engine uses shared locks to enforce the default isolation level.</span></span> <span data-ttu-id="207b6-155">Pokud nastavíte možnost databáze READ_COMMITTED_SNAPSHOT na ON, databázový stroj řádek správy verzí a snímek izolace použije jako výchozí, místo použití zámků k ochraně dat.</span><span class="sxs-lookup"><span data-stu-id="207b6-155">If you set the READ_COMMITTED_SNAPSHOT database option to ON, the database engine uses row versioning and snapshot isolation as the default, instead of using locks to protect the data.</span></span>  
  
## <a name="how-snapshot-isolation-and-row-versioning-work"></a><span data-ttu-id="207b6-156">Jak snímek izolace a řádek pracovní správy verzí</span><span class="sxs-lookup"><span data-stu-id="207b6-156">How Snapshot Isolation and Row Versioning Work</span></span>  
 <span data-ttu-id="207b6-157">Pokud je povolena úroveň izolace SNÍMKU, pokaždé, když se aktualizuje řádek, databázový stroj SQL serveru ukládá jejich kopii původní řádek v **tempdb**a přidá číslo sekvence transakce na řádek.</span><span class="sxs-lookup"><span data-stu-id="207b6-157">When the SNAPSHOT isolation level is enabled, each time a row is updated, the SQL Server Database Engine stores a copy of the original row in **tempdb**, and adds a transaction sequence number to the row.</span></span> <span data-ttu-id="207b6-158">Posloupnost událostí, ke které dochází, je následující:</span><span class="sxs-lookup"><span data-stu-id="207b6-158">The following is the sequence of events that occurs:</span></span>  
  
-   <span data-ttu-id="207b6-159">Zahájené novou transakci a má přiřazené pořadové číslo transakce.</span><span class="sxs-lookup"><span data-stu-id="207b6-159">A new transaction is initiated, and it is assigned a transaction sequence number.</span></span>  
  
-   <span data-ttu-id="207b6-160">Databázový stroj přečte řádek v rámci transakce a načte verze řádku z **tempdb** jehož pořadové číslo je nejblíže a nižší transakce pořadové číslo.</span><span class="sxs-lookup"><span data-stu-id="207b6-160">The Database Engine reads a row within the transaction and retrieves the row version from **tempdb** whose sequence number is closest to, and lower than, the transaction sequence number.</span></span>  
  
-   <span data-ttu-id="207b6-161">Databázový stroj zkontroluje, zda transakce pořadové číslo není v seznamu číslem nepotvrzené transakce aktivní transakce, při zahájení transakce snímku.</span><span class="sxs-lookup"><span data-stu-id="207b6-161">The Database Engine checks to see if the transaction sequence number is not in the list of transaction sequence numbers of the uncommitted transactions active when the snapshot transaction started.</span></span>  
  
-   <span data-ttu-id="207b6-162">Transakce čtení verzi řádku z **tempdb** , který byl aktuální v době spuštění transakce.</span><span class="sxs-lookup"><span data-stu-id="207b6-162">The transaction reads the version of the row from **tempdb** that was current as of the start of the transaction.</span></span> <span data-ttu-id="207b6-163">Neuvidí vložené po transakce bylo spuštěno, protože tyto hodnoty čísla pořadí bude vyšší než hodnota transakce pořadové číslo nové řádky.</span><span class="sxs-lookup"><span data-stu-id="207b6-163">It will not see new rows inserted after the transaction was started because those sequence number values will be higher than the value of the transaction sequence number.</span></span>  
  
-   <span data-ttu-id="207b6-164">Aktuální transakce se zobrazí řádky, které byly odstraněny po zahájení transakce, protože budou verze řádku v **tempdb** s nižší hodnotou číslo sekvence.</span><span class="sxs-lookup"><span data-stu-id="207b6-164">The current transaction will see rows that were deleted after the transaction began, because there will be a row version in **tempdb** with a lower sequence number value.</span></span>  
  
 <span data-ttu-id="207b6-165">Čistým důsledkem toho izolaci snímku je, že transakce se zobrazí všechna data tak, jak byly na začátku transakce, bez příslušných nebo umístění žádné zámky na základní tabulky.</span><span class="sxs-lookup"><span data-stu-id="207b6-165">The net effect of snapshot isolation is that the transaction sees all of the data as it existed at the start of the transaction, without honoring or placing any locks on the underlying tables.</span></span> <span data-ttu-id="207b6-166">Může dojít k vylepšení výkonu v situacích, kde je nutné vyřešit.</span><span class="sxs-lookup"><span data-stu-id="207b6-166">This can result in performance improvements in situations where there is contention.</span></span>  
  
 <span data-ttu-id="207b6-167">Transakce snapshot vždy používá optimistického řízení souběžnosti, odmítnutí žádné zámky, které by jinak znemožňovaly ostatní transakce z aktualizace řádků.</span><span class="sxs-lookup"><span data-stu-id="207b6-167">A snapshot transaction always uses optimistic concurrency control, withholding any locks that would prevent other transactions from updating rows.</span></span> <span data-ttu-id="207b6-168">Pokud transakce snímku se pokusí provést aktualizace řádku, který byl změněn po zahájení transakce, transakce se zrušila a dojde k chybě.</span><span class="sxs-lookup"><span data-stu-id="207b6-168">If a snapshot transaction attempts to commit an update to a row that was changed after the transaction began, the transaction is rolled back, and an error is raised.</span></span>  
  
## <a name="working-with-snapshot-isolation-in-adonet"></a><span data-ttu-id="207b6-169">Práce s izolací snímku v ADO.NET</span><span class="sxs-lookup"><span data-stu-id="207b6-169">Working with Snapshot Isolation in ADO.NET</span></span>  
 <span data-ttu-id="207b6-170">Izolace snímku se podporuje v ADO.NET pomocí <xref:System.Data.SqlClient.SqlTransaction> třídy.</span><span class="sxs-lookup"><span data-stu-id="207b6-170">Snapshot isolation is supported in ADO.NET by the <xref:System.Data.SqlClient.SqlTransaction> class.</span></span> <span data-ttu-id="207b6-171">Pokud databázi byl povolen pro izolaci snímku, ale není nakonfigurovaný pro možnost READ_COMMITTED_SNAPSHOT ON, je nutné inicializovat <xref:System.Data.SqlClient.SqlTransaction> pomocí **IsolationLevel.Snapshot** hodnota výčtu při volání <xref:System.Data.SqlClient.SqlConnection.BeginTransaction%2A> Metoda.</span><span class="sxs-lookup"><span data-stu-id="207b6-171">If a database has been enabled for snapshot isolation but is not configured for READ_COMMITTED_SNAPSHOT ON, you must initiate a <xref:System.Data.SqlClient.SqlTransaction> using the **IsolationLevel.Snapshot** enumeration value when calling the <xref:System.Data.SqlClient.SqlConnection.BeginTransaction%2A> method.</span></span> <span data-ttu-id="207b6-172">Tento fragment kódu předpokládá, že připojení je otevřený <xref:System.Data.SqlClient.SqlConnection> objektu.</span><span class="sxs-lookup"><span data-stu-id="207b6-172">This code fragment assumes that connection is an open <xref:System.Data.SqlClient.SqlConnection> object.</span></span>  
  
```vb  
Dim sqlTran As SqlTransaction = _  
  connection.BeginTransaction(IsolationLevel.Snapshot)  
```  
  
```csharp  
SqlTransaction sqlTran =   
  connection.BeginTransaction(IsolationLevel.Snapshot);  
```  
  
### <a name="example"></a><span data-ttu-id="207b6-173">Příklad</span><span class="sxs-lookup"><span data-stu-id="207b6-173">Example</span></span>  
 <span data-ttu-id="207b6-174">Následující příklad ukazuje, jak se chovají úrovních různé izolace pokusem o přístup k datům uzamčené a není určena pro použití v produkčním kódu.</span><span class="sxs-lookup"><span data-stu-id="207b6-174">The following example demonstrates how the different isolation levels behave by attempting to access locked data, and it is not intended to be used in production code.</span></span>  
  
 <span data-ttu-id="207b6-175">Kód se připojí k **AdventureWorks** ukázková databáze na SQL serveru a vytvoří tabulku s názvem **TestSnapshot** a vloží jeden řádek dat.</span><span class="sxs-lookup"><span data-stu-id="207b6-175">The code connects to the **AdventureWorks** sample database in SQL Server and creates a table named **TestSnapshot** and inserts one row of data.</span></span> <span data-ttu-id="207b6-176">Tento kód použije příkaz ALTER DATABASE jazyka Transact-SQL k zapnutí nastavení v izolaci snímku databáze, ale není nastavena možnost READ_COMMITTED_SNAPSHOT ponechat výchozí chování úroveň izolace READ COMMITTED v platnosti.</span><span class="sxs-lookup"><span data-stu-id="207b6-176">The code uses the ALTER DATABASE Transact-SQL statement to turn on snapshot isolation for the database, but it does not set the READ_COMMITTED_SNAPSHOT option, leaving the default READ COMMITTED isolation-level behavior in effect.</span></span> <span data-ttu-id="207b6-177">Kód poté provede následující akce:</span><span class="sxs-lookup"><span data-stu-id="207b6-177">The code then performs the following actions:</span></span>  
  
-   <span data-ttu-id="207b6-178">Začne, ale nebude dokončen, sqlTransaction1, který používá ke spuštění transakce aktualizace úrovně izolace SERIALIZABLE.</span><span class="sxs-lookup"><span data-stu-id="207b6-178">It begins, but does not complete, sqlTransaction1, which uses the SERIALIZABLE isolation level to start an update transaction.</span></span> <span data-ttu-id="207b6-179">To má vliv na uzamčení v tabulce.</span><span class="sxs-lookup"><span data-stu-id="207b6-179">This has the effect of locking the table.</span></span>  
  
-   <span data-ttu-id="207b6-180">Otevře se druhé připojení a inicializuje druhý pomocí na úrovni izolace SNÍMKU číst data v transakci **TestSnapshot** tabulky.</span><span class="sxs-lookup"><span data-stu-id="207b6-180">It opens a second connection and initiates a second transaction using the SNAPSHOT isolation level to read the data in the **TestSnapshot** table.</span></span> <span data-ttu-id="207b6-181">Protože je povolena izolace snímku, tuto transakci může číst data, která existovala předtím, než sqlTransaction1 spuštěna.</span><span class="sxs-lookup"><span data-stu-id="207b6-181">Because snapshot isolation is enabled, this transaction can read the data that existed before sqlTransaction1 started.</span></span>  
  
-   <span data-ttu-id="207b6-182">Otevře se třetí připojení a zahájí transakci pro čtení úrovně izolace pomocí pokus o čtení dat v tabulce.</span><span class="sxs-lookup"><span data-stu-id="207b6-182">It opens a third connection and initiates a transaction using the READ COMMITTED isolation level to attempt to read the data in the table.</span></span> <span data-ttu-id="207b6-183">Kód v tomto případě nelze číst data, protože nelze přečíst poslední zámků v tabulce v první transakce a vyprší. Stejného výsledku ke kterým by úrovně izolace OPAKOVATELNÉ čtení a SERIALIZABLE byly použít, protože tyto úrovně izolace nelze také čtení za zámků v první transakce.</span><span class="sxs-lookup"><span data-stu-id="207b6-183">In this case, the code cannot read the data because it cannot read past the locks placed on the table in the first transaction and times out. The same result would occur if the REPEATABLE READ and SERIALIZABLE isolation levels were used because these isolation levels also cannot read past the locks placed in the first transaction.</span></span>  
  
-   <span data-ttu-id="207b6-184">Otevře čtvrtý připojení a zahájí pomocí NEPOTVRZENÉ čtení úroveň izolace, která vede sqlTransaction1 nepřesný hodnotu nepotvrzené transakce.</span><span class="sxs-lookup"><span data-stu-id="207b6-184">It opens a fourth connection and initiates a transaction using the READ UNCOMMITTED isolation level, which performs a dirty read of the uncommitted value in sqlTransaction1.</span></span> <span data-ttu-id="207b6-185">Tato hodnota může nikdy skutečně existují v databázi, pokud první transakce není potvrzená.</span><span class="sxs-lookup"><span data-stu-id="207b6-185">This value may never actually exist in the database if the first transaction is not committed.</span></span>  
  
-   <span data-ttu-id="207b6-186">Vrátí první transakce a vyčistí odstraněním **TestSnapshot** izolace pro tabulky a vypnutí snímku **AdventureWorks** databáze.</span><span class="sxs-lookup"><span data-stu-id="207b6-186">It rolls back the first transaction and cleans up by deleting the **TestSnapshot** table and turning off snapshot isolation for the **AdventureWorks** database.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="207b6-187">Následující příklady používají stejný připojovací řetězec s sdružování připojení vypnuté.</span><span class="sxs-lookup"><span data-stu-id="207b6-187">The following examples use the same connection string with connection pooling turned off.</span></span> <span data-ttu-id="207b6-188">Pokud je ve fondu připojení, resetování jeho úroveň izolace není resetovaný úroveň izolace na serveru.</span><span class="sxs-lookup"><span data-stu-id="207b6-188">If a connection is pooled, resetting its isolation level does not reset the isolation level at the server.</span></span> <span data-ttu-id="207b6-189">V důsledku toho další připojení, které používají stejné připojení ve fondu vnitřní začínat jejich izolace úrovně nastavena na hodnotu, která ve fondu připojení.</span><span class="sxs-lookup"><span data-stu-id="207b6-189">As a result, subsequent connections that use the same pooled inner connection start with their isolation levels set to that of the pooled connection.</span></span> <span data-ttu-id="207b6-190">Alternativa k vypnutí sdružování připojení je nastavit úroveň izolace explicitně pro každé připojení.</span><span class="sxs-lookup"><span data-stu-id="207b6-190">An alternative to turning off connection pooling is to set the isolation level explicitly for each connection.</span></span>  
  
 [!code-csharp[DataWorks SnapshotIsolation.Demo#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SnapshotIsolation.Demo/CS/source.cs#1)]
 [!code-vb[DataWorks SnapshotIsolation.Demo#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SnapshotIsolation.Demo/VB/source.vb#1)]  
  
### <a name="example"></a><span data-ttu-id="207b6-191">Příklad</span><span class="sxs-lookup"><span data-stu-id="207b6-191">Example</span></span>  
 <span data-ttu-id="207b6-192">Následující příklad ukazuje chování izolace snímku, když se změní data.</span><span class="sxs-lookup"><span data-stu-id="207b6-192">The following example demonstrates the behavior of snapshot isolation when data is being modified.</span></span> <span data-ttu-id="207b6-193">Kód provede následující akce:</span><span class="sxs-lookup"><span data-stu-id="207b6-193">The code performs the following actions:</span></span>  
  
-   <span data-ttu-id="207b6-194">Se připojí k **AdventureWorks** ukázkové databáze a umožňuje izolaci SNÍMKU.</span><span class="sxs-lookup"><span data-stu-id="207b6-194">Connects to the **AdventureWorks** sample database and enables SNAPSHOT isolation.</span></span>  
  
-   <span data-ttu-id="207b6-195">Vytvoří tabulku s názvem **TestSnapshotUpdate** a vloží tři řádky ukázková data.</span><span class="sxs-lookup"><span data-stu-id="207b6-195">Creates a table named **TestSnapshotUpdate** and inserts three rows of sample data.</span></span>  
  
-   <span data-ttu-id="207b6-196">Začne, ale nebude dokončen, sqlTransaction1 pomocí izolace SNÍMKU.</span><span class="sxs-lookup"><span data-stu-id="207b6-196">Begins, but does not complete, sqlTransaction1 using SNAPSHOT isolation.</span></span> <span data-ttu-id="207b6-197">Tří řádků dat jsou vybrány v transakci.</span><span class="sxs-lookup"><span data-stu-id="207b6-197">Three rows of data are selected in the transaction.</span></span>  
  
-   <span data-ttu-id="207b6-198">Vytvoří druhou **SqlConnection** k **AdventureWorks** a vytvoří druhý transakci pomocí úrovní izolace READ COMMITTED, která aktualizuje hodnotu v jednom z vybraných v sqlTransaction1 řádků.</span><span class="sxs-lookup"><span data-stu-id="207b6-198">Creates a second **SqlConnection** to **AdventureWorks** and creates a second transaction using the READ COMMITTED isolation level that updates a value in one of the rows selected in sqlTransaction1.</span></span>  
  
-   <span data-ttu-id="207b6-199">SqlTransaction2 potvrzení změn.</span><span class="sxs-lookup"><span data-stu-id="207b6-199">Commits sqlTransaction2.</span></span>  
  
-   <span data-ttu-id="207b6-200">Vrátí sqlTransaction1 a pokusy o aktualizaci na stejném řádku tohoto sqlTransaction1 už je potvrzená.</span><span class="sxs-lookup"><span data-stu-id="207b6-200">Returns to sqlTransaction1 and attempts to update the same row that sqlTransaction1 already committed.</span></span> <span data-ttu-id="207b6-201">Je vyvolána chyba 3960 a sqlTransaction1 se vrátí zpět automaticky.</span><span class="sxs-lookup"><span data-stu-id="207b6-201">Error 3960 is raised, and sqlTransaction1 is rolled back automatically.</span></span> <span data-ttu-id="207b6-202">**SqlException.Number** a **SqlException.Message** jsou zobrazeny v okně konzoly.</span><span class="sxs-lookup"><span data-stu-id="207b6-202">The **SqlException.Number** and **SqlException.Message** are displayed in the Console window.</span></span>  
  
-   <span data-ttu-id="207b6-203">Spustí kód pro vyčištění k vypnutí možnosti izolace snímku v **AdventureWorks** a odstranit **TestSnapshotUpdate** tabulky.</span><span class="sxs-lookup"><span data-stu-id="207b6-203">Executes clean-up code to turn off snapshot isolation in **AdventureWorks** and delete the **TestSnapshotUpdate** table.</span></span>  
  
 [!code-csharp[DataWorks SnapshotIsolation.DemoUpdate#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SnapshotIsolation.DemoUpdate/CS/source.cs#1)]
 [!code-vb[DataWorks SnapshotIsolation.DemoUpdate#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SnapshotIsolation.DemoUpdate/VB/source.vb#1)]  
  
### <a name="using-lock-hints-with-snapshot-isolation"></a><span data-ttu-id="207b6-204">Použití pomocné parametry zámku s izolací snímku</span><span class="sxs-lookup"><span data-stu-id="207b6-204">Using Lock Hints with Snapshot Isolation</span></span>  
 <span data-ttu-id="207b6-205">V předchozím příkladu vybere první transakce data, a druhá transakce aktualizuje data před první transakce je možné dokončit, způsobí došlo ke konfliktu aktualizací, když se první transakce pokusí aktualizovat na stejném řádku.</span><span class="sxs-lookup"><span data-stu-id="207b6-205">In the previous example, the first transaction selects data, and a second transaction updates the data before the first transaction is able to complete, causing an update conflict when the first transaction tries to update the same row.</span></span> <span data-ttu-id="207b6-206">Zadáním pomocné parametry zámku na začátku transakce můžete snížit pravděpodobnost konfliktů při aktualizacích v dlouhotrvajících transakcí snímku.</span><span class="sxs-lookup"><span data-stu-id="207b6-206">You can reduce the chance of update conflicts in long-running snapshot transactions by supplying lock hints at the beginning of the transaction.</span></span> <span data-ttu-id="207b6-207">Následující příkaz SELECT pomocí pomocný parametr UPDLOCK uzamkne vybrané řádky:</span><span class="sxs-lookup"><span data-stu-id="207b6-207">The following SELECT statement uses the UPDLOCK hint to lock the selected rows:</span></span>  
  
```  
SELECT * FROM TestSnapshotUpdate WITH (UPDLOCK)   
  WHERE PriKey BETWEEN 1 AND 3  
```  
  
 <span data-ttu-id="207b6-208">Pomocí bloků pomocný parametr zámku UPDLOCK všechny řádky, pokus o aktualizaci řádků před první transakce dokončena.</span><span class="sxs-lookup"><span data-stu-id="207b6-208">Using the UPDLOCK lock hint blocks any rows attempting to update the rows before the first transaction completes.</span></span> <span data-ttu-id="207b6-209">Zaručí se tak, že mají vybrané řádky žádné konflikty. když se aktualizují později v transakci.</span><span class="sxs-lookup"><span data-stu-id="207b6-209">This guarantees that the selected rows have no conflicts when they are updated later in the transaction.</span></span> <span data-ttu-id="207b6-210">Viz "Pomocné parametry zámku" v SQL Server Books Online.</span><span class="sxs-lookup"><span data-stu-id="207b6-210">See "Locking Hints" in SQL Server Books Online.</span></span>  
  
 <span data-ttu-id="207b6-211">Pokud vaše aplikace obsahuje mnoho konflikty, izolaci snímku nemusí být nejlepší volbou.</span><span class="sxs-lookup"><span data-stu-id="207b6-211">If your application has many conflicts, snapshot isolation may not be the best choice.</span></span> <span data-ttu-id="207b6-212">Pomocné parametry by měla sloužit pouze při opravdu potřebujete.</span><span class="sxs-lookup"><span data-stu-id="207b6-212">Hints should only be used when really needed.</span></span> <span data-ttu-id="207b6-213">Aplikace by neměl být navržený tak, aby neustále spoléhá na pomocné parametry zámku pro jeho operace.</span><span class="sxs-lookup"><span data-stu-id="207b6-213">Your application should not be designed so that it constantly relies on lock hints for its operation.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="207b6-214">Viz také</span><span class="sxs-lookup"><span data-stu-id="207b6-214">See Also</span></span>  
 [<span data-ttu-id="207b6-215">SQL Server a ADO.NET</span><span class="sxs-lookup"><span data-stu-id="207b6-215">SQL Server and ADO.NET</span></span>](../../../../../docs/framework/data/adonet/sql/index.md)  
 [<span data-ttu-id="207b6-216">ADO.NET spravovaných zprostředkovatelích a datové sady pro vývojáře</span><span class="sxs-lookup"><span data-stu-id="207b6-216">ADO.NET Managed Providers and DataSet Developer Center</span></span>](https://go.microsoft.com/fwlink/?LinkId=217917)
