---
title: Správa kontextu datové služby (WCF Data Services)
ms.date: 03/30/2017
ms.assetid: 15b19d09-7de7-4638-9556-6ef396cc45ec
ms.openlocfilehash: 621887f2814127c7c6800fecc9ade1e161db46e0
ms.sourcegitcommit: f348c84443380a1959294cdf12babcb804cfa987
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 11/12/2019
ms.locfileid: "73975200"
---
# <a name="managing-the-data-service-context-wcf-data-services"></a>Správa kontextu datové služby (WCF Data Services)
Třída <xref:System.Data.Services.Client.DataServiceContext> zapouzdřuje operace, které jsou podporovány pro zadanou datovou službu. I když služba OData je Bezstavová, kontext není. Proto můžete použít třídu <xref:System.Data.Services.Client.DataServiceContext> k údržbě stavu klienta mezi interakcemi s datovou službou, aby bylo možné podporovat funkce, jako je například Správa změn. Tato třída také spravuje identity a sleduje změny.  
  
## <a name="merge-options-and-identity-resolution"></a>Možnosti sloučení a rozlišení identity  
 Při spuštění <xref:System.Data.Services.Client.DataServiceQuery%601> jsou entity v kanálu odpovědí vyhodnoceny na objekty. Další informace naleznete v tématu [materializace objektů](object-materialization-wcf-data-services.md). Způsob, jakým jsou položky ve zprávě odpovědi materializované, se provádí na základě překladu identity a závisí na možnosti sloučení, na které se dotaz spustil. Pokud se v oboru jednoho <xref:System.Data.Services.Client.DataServiceContext>spustí více dotazů nebo požadavků na načtení, klient [!INCLUDE[ssAstoria](../../../../includes/ssastoria-md.md)] sleduje pouze jednu instanci objektu, která má konkrétní hodnotu klíče. Tento klíč, který se používá k provedení překladu identity, jednoznačně identifikuje entitu.  
  
 Ve výchozím nastavení klient materializuje pouze záznam v kanálu odpovědí do objektu pro entity, které již nejsou sledovány <xref:System.Data.Services.Client.DataServiceContext>. To znamená, že změny objektů, které již jsou v mezipaměti, nejsou přepsány. Toto chování se řídí zadáním <xref:System.Data.Services.Client.MergeOption> hodnoty pro dotazy a operace načítání. Tato možnost je určena nastavením vlastnosti <xref:System.Data.Services.Client.DataServiceContext.MergeOption%2A> v <xref:System.Data.Services.Client.DataServiceContext>. Výchozí hodnota možnosti sloučení je <xref:System.Data.Services.Client.MergeOption.AppendOnly>. Tím pouze materializuje objekty pro entity, které ještě nejsou sledovány, což znamená, že existující objekty nebudou přepsány. Dalším způsobem, jak zabránit změnám objektů v klientovi, aby byly přepsány aktualizacemi z datové služby, je určit <xref:System.Data.Services.Client.MergeOption.PreserveChanges>. Pokud zadáte <xref:System.Data.Services.Client.MergeOption.OverwriteChanges>, hodnoty objektů v klientovi budou nahrazeny nejnovějšími hodnotami z položek v kanálu odpovědí, i když již byly provedeny změny těchto objektů. Při použití možnosti sloučení <xref:System.Data.Services.Client.MergeOption.NoTracking> nemůže <xref:System.Data.Services.Client.DataServiceContext> odeslat změny provedené u klientských objektů do datové služby. Při této možnosti jsou změny vždy přepsány hodnotami z datové služby.  
  
## <a name="managing-concurrency"></a>Správa souběžnosti  
 OData podporuje optimistickou souběžnost, která umožňuje datové službě detekovat konflikty aktualizací. Zprostředkovatele datové služby lze nakonfigurovat takovým způsobem, který datová služba kontroluje změny entit pomocí tokenu souběžnosti. Tento token zahrnuje jednu nebo více vlastností typu entity, které jsou ověřovány datovou službou, aby bylo možné zjistit, zda došlo ke změně prostředku. Tokeny souběžnosti, které jsou zahrnuty v hlavičce eTag požadavků na a odpovědi z datové služby, jsou spravovány klientem [!INCLUDE[ssAstoria](../../../../includes/ssastoria-md.md)]. Další informace najdete v tématu [aktualizace datové služby](updating-the-data-service-wcf-data-services.md).  
  
 <xref:System.Data.Services.Client.DataServiceContext> sleduje změny provedené v objektech, které byly hlášeny ručně pomocí <xref:System.Data.Services.Client.DataServiceContext.AddObject%2A>, <xref:System.Data.Services.Client.DataServiceContext.UpdateObject%2A>a <xref:System.Data.Services.Client.DataServiceContext.DeleteObject%2A>nebo <xref:System.Data.Services.Client.DataServiceCollection%601>. Když je volána metoda <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A>, klient odesílá změny zpět do datové služby. <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> může selhat při změně dat v konfliktu klienta se změnami v datové službě. V takovém případě je nutné znovu zadat dotaz na prostředek entity, aby bylo možné přijímat data aktualizací. Chcete-li přepsat změny v datové službě, spusťte dotaz pomocí možnosti <xref:System.Data.Services.Client.MergeOption.PreserveChanges> sloučit. Když zavoláte <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> znovu, změny zachované na klientovi budou trvalé pro datovou službu, pokud ještě nejsou v prostředku v datové službě provedeny jiné změny.  
  
## <a name="saving-changes"></a>Uložení změn  
 Změny jsou sledovány v instanci <xref:System.Data.Services.Client.DataServiceContext>, ale nejsou odesílány přímo na server. Po dokončení požadovaných změn u zadané aktivity zavolejte <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> pro odeslání všech změn do datové služby. Po dokončení operace <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> se vrátí objekt <xref:System.Data.Services.Client.DataServiceResponse>. Objekt <xref:System.Data.Services.Client.DataServiceResponse> obsahuje sekvenci <xref:System.Data.Services.Client.OperationResponse> objektů, které zase obsahují sekvenci <xref:System.Data.Services.Client.EntityDescriptor> nebo <xref:System.Data.Services.Client.LinkDescriptor> instancí, které reprezentují změny trvalé nebo pokusy. Když je v datové službě vytvořená nebo upravená entita, <xref:System.Data.Services.Client.EntityDescriptor> obsahuje odkaz na aktualizovanou entitu včetně všech hodnot vygenerovaných serverem, jako je například vygenerovaná hodnota `ProductID` v předchozím příkladu. Klientská knihovna automaticky aktualizuje .NET Framework objekt na tyto nové hodnoty.  
  
 Pro úspěšné operace INSERT a Update je vlastnost State objektu <xref:System.Data.Services.Client.EntityDescriptor> nebo <xref:System.Data.Services.Client.LinkDescriptor>, která je přidružená k operaci, nastavena na hodnotu <xref:System.Data.Services.Client.EntityStates.Unchanged> a nové hodnoty jsou sloučeny pomocí <xref:System.Data.Services.Client.MergeOption.OverwriteChanges>. V případě, že operace vložení, aktualizace nebo odstranění v datové službě dojde k chybě, stav entity zůstane stejný jako předtím, než byla volána <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> a vlastnost <xref:System.Data.Services.Client.OperationResponse.Error%2A> <xref:System.Data.Services.Client.OperationResponse> je nastavena na <xref:System.Data.Services.Client.DataServiceRequestException>, který obsahuje informace o chybě. Další informace najdete v tématu [aktualizace datové služby](updating-the-data-service-wcf-data-services.md).  
  
### <a name="setting-the-http-method-for-updates"></a>Nastavení metody HTTP pro aktualizace  
 Ve výchozím nastavení Klientská knihovna .NET Framework odesílá aktualizace stávajících entit jako požadavky na sloučení. Požadavek sloučení aktualizuje vybrané vlastnosti entity. klient ale vždy obsahuje všechny vlastnosti v žádosti o sloučení, dokonce i vlastnosti, které se nezměnily. Protokol OData také podporuje odesílání požadavků PUT na aktualizace entit. V požadavku PUT je existující entita v podstatě nahrazena novou instancí entity s hodnotami vlastností z klienta. Chcete-li použít požadavky PUT, nastavte příznak <xref:System.Data.Services.Client.SaveChangesOptions.ReplaceOnUpdate> u výčtu <xref:System.Data.Services.Client.SaveChangesOptions> při volání <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A>.  
  
> [!NOTE]
> Požadavek PUT se bude chovat jinak než požadavek sloučení, pokud klient neví o všech vlastnostech entity. K tomu může dojít při projekci typu entity do nového typu na klientovi. Může se taky vyskytnout, když se do entity v modelu dat služby přidají nové vlastnosti a vlastnost <xref:System.Data.Services.Client.DataServiceContext.IgnoreMissingProperties%2A> v <xref:System.Data.Services.Client.DataServiceContext> je nastavená na `true`, aby se tyto chyby mapování klientů ignorovaly. V těchto případech požadavek PUT obnoví všechny vlastnosti, které jsou pro klienta neznámé, na výchozí hodnoty.  
  
### <a name="post-tunneling"></a>POST Tunneling  
 Ve výchozím nastavení odesílá Klientská knihovna požadavky na vytváření, čtení, aktualizaci a odstraňování na službu OData pomocí odpovídajících metod HTTP POST, GET, PUT, MERGE/PATCH a DELETE. Tím se zablokuje základní principy převodu stavu (REST). Nicméně ne každá implementace webového serveru podporuje úplnou sadu metod HTTP. V některých případech můžou být podporované metody omezené jenom na GET a POST. K tomu může dojít, když prostředník, jako je brána firewall, blokuje žádosti s určitými metodami. Vzhledem k tomu, že metody GET a POST jsou nejčastěji podporovány, Služba OData stanoví způsob, jak spouštět jakékoli nepodporované metody HTTP pomocí žádosti POST. Tato možnost umožňuje klientovi odeslat požadavek POST se skutečnou metodou určenou v hlavičce vlastního `X-HTTP-Method`, která se označuje jako *tunelová* *nebo výstupní*. Pokud chcete pro žádosti povolit odesílání po tunelování, nastavte vlastnost <xref:System.Data.Services.Client.DataServiceContext.UsePostTunneling%2A> v instanci <xref:System.Data.Services.Client.DataServiceContext> na `true`.  
  
## <a name="see-also"></a>Viz také:

- [Klientská knihovna pro WCF Data Services](wcf-data-services-client-library.md)
- [Aktualizace datové služby](updating-the-data-service-wcf-data-services.md)
- [Asynchronní operace](asynchronous-operations-wcf-data-services.md)
- [Operace dávkování](batching-operations-wcf-data-services.md)
