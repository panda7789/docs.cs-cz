---
title: Optimalizace pomocí jednofázového potvrzení a možné zařazení jednofázového oznámení
description: Optimalizujte výkon pomocí jediné fáze potvrzení a oznámení s jednou fází. Přečtěte si o infrastruktuře System. Transactions v .NET.
ms.date: 03/30/2017
ms.assetid: 57beaf1a-fb4d-441a-ab1d-bc0c14ce7899
ms.openlocfilehash: 89ce82e673340c93254983c078f78a2501129383
ms.sourcegitcommit: 6219b1e1feccb16d88656444210fed3297f5611e
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 06/22/2020
ms.locfileid: "85141975"
---
# <a name="optimization-using-single-phase-commit-and-promotable-single-phase-notification"></a><span data-ttu-id="061c8-104">Optimalizace pomocí jednofázového potvrzení a možné zařazení jednofázového oznámení</span><span class="sxs-lookup"><span data-stu-id="061c8-104">Optimization using Single Phase Commit and Promotable Single Phase Notification</span></span>

<span data-ttu-id="061c8-105">Toto téma popisuje mechanismy poskytované <xref:System.Transactions> infrastruktury za účelem optimalizace výkonu.</span><span class="sxs-lookup"><span data-stu-id="061c8-105">This topic describes the mechanisms provided by the <xref:System.Transactions> infrastructure to optimize performance.</span></span>

## <a name="promotable-single-phase-enlistment"></a><span data-ttu-id="061c8-106">Zařazení možné jedna fáze</span><span class="sxs-lookup"><span data-stu-id="061c8-106">Promotable Single Phase Enlistment</span></span>

<span data-ttu-id="061c8-107"><xref:System.Transactions> Infrastruktury administrates transakcí v rámci jedné aplikační domény, který zahrnuje maximálně jeden prostředek trvalý nebo více těkavých zdrojů.</span><span class="sxs-lookup"><span data-stu-id="061c8-107">The <xref:System.Transactions> infrastructure administrates a transaction inside a single application domain that involves at most a single durable resource or multiple volatile resources.</span></span> <span data-ttu-id="061c8-108">Vzhledem k tomu <xref:System.Transactions> infrastruktura používá volání pouze uvnitř aplikační domény, bude vrácen nejlepší propustnost a výkonu.</span><span class="sxs-lookup"><span data-stu-id="061c8-108">Since the <xref:System.Transactions> infrastructure uses only intra-application domain calls, it yields the best throughput and performance.</span></span>

<span data-ttu-id="061c8-109">Nicméně, pokud transakce je k dispozici na jiný objekt v jiné doméně aplikace (včetně přes hranice procesu a strojově), ve stejném počítači, nebo pokud jste byli k zařazení jiného správce prostředků trvalý, <xref:System.Transactions> infrastruktury automaticky eskaluje transakce jej lze spravovat pomocí příkaz MSDTC.</span><span class="sxs-lookup"><span data-stu-id="061c8-109">However, if the transaction is provided to another object in another application domain (including across process and machine boundaries) on the same computer, or if you were to enlist another durable resource manager, the <xref:System.Transactions> infrastructure automatically escalates the transaction to be managed by the MSDTC.</span></span> <span data-ttu-id="061c8-110">Spravuje MSDTC transakcí není jako jedna spravuje performance-wise <xref:System.Transactions> infrastruktury.</span><span class="sxs-lookup"><span data-stu-id="061c8-110">A transaction managed by MSDTC is not as performance-wise as one managed by the <xref:System.Transactions> infrastructure.</span></span>

<span data-ttu-id="061c8-111">Za účelem optimalizace výkonu, <xref:System.Transactions> možné jedné fáze zařazení (PSPE) umožňující na jeden vzdálený trvalý prostředek umístěný v různých aplikační domény, procesu nebo počítač, abyste se mohli účastnit v poskytuje infrastrukturu <xref:System.Transactions> transakce, aniž by ji chcete-li být rozšířena na transakci MSDTC.</span><span class="sxs-lookup"><span data-stu-id="061c8-111">To optimize performance, the <xref:System.Transactions> infrastructure provides the Promotable Single Phase Enlistment (PSPE) that allows a single remote durable resource, located in a different application domain, process or machine, to participate in a <xref:System.Transactions> transaction without causing it to be escalated to an MSDTC transaction.</span></span> <span data-ttu-id="061c8-112">Tento správce prostředků (SV) můžete hostovat a "vlastní" transakce, který lze později být rozšířena na distribuovaných transakcí (nebo transakce MSDTC) v případě potřeby.</span><span class="sxs-lookup"><span data-stu-id="061c8-112">This resource manager (RM) can host and "own" a transaction that can later be escalated to a distributed transaction (or MSDTC transaction) if necessary.</span></span> <span data-ttu-id="061c8-113">Tím omezíte možnost pomocí příkaz MSDTC.</span><span class="sxs-lookup"><span data-stu-id="061c8-113">This reduces the chance of using the MSDTC.</span></span>

<span data-ttu-id="061c8-114">Tento konkrétní zdroj správce obvykle má svou vlastní interní bez distribuované transakce a musí podporovat převod těchto transakcí na distribuované transakce za běhu.</span><span class="sxs-lookup"><span data-stu-id="061c8-114">This specific resource manager usually has its own internal non distributed transactions and it needs to support converting those transactions to distributed transactions at runtime.</span></span> <span data-ttu-id="061c8-115">SQL Server 2005 je například správce prostředků.</span><span class="sxs-lookup"><span data-stu-id="061c8-115">For example, SQL Server 2005 is such a resource manager.</span></span> <span data-ttu-id="061c8-116">V takovém případě <xref:System.Transactions> infrastruktury přebírá roli pasivní Správa právě sledováním transakci pro potřebu eskalace.</span><span class="sxs-lookup"><span data-stu-id="061c8-116">In such case, the <xref:System.Transactions> infrastructure takes a passive management role by just monitoring the transaction for a need for escalation.</span></span> <span data-ttu-id="061c8-117">Pro podporu interakce mezi <xref:System.Transactions> manager infrastruktury a prostředků, druhém musí implementovat rozhraní <xref:System.Transactions.IPromotableSinglePhaseNotification>.</span><span class="sxs-lookup"><span data-stu-id="061c8-117">To support the interaction between the <xref:System.Transactions> infrastructure and resource manager, the latter needs to implement the interface <xref:System.Transactions.IPromotableSinglePhaseNotification>.</span></span>

<span data-ttu-id="061c8-118"><xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> Metoda se používá k zařazení jednoho trvalého prostředek, který lze později eskalován.</span><span class="sxs-lookup"><span data-stu-id="061c8-118">The <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> method is used to enlist a single durable resource that can be escalated later.</span></span> <span data-ttu-id="061c8-119">Tato metoda zajišťuje, že zařazení může být eskalován podle potřeby.</span><span class="sxs-lookup"><span data-stu-id="061c8-119">This method ensures that the enlistment can be escalated as needed.</span></span> <span data-ttu-id="061c8-120">Pokud zařazení úspěšná, správce prostředků vytvoří jeho vnitřní transakci a přidruží ji k <xref:System.Transactions> transakce.</span><span class="sxs-lookup"><span data-stu-id="061c8-120">If the enlistment succeeds, the RM creates its internal transaction and associates it with the <xref:System.Transactions> transaction.</span></span> <span data-ttu-id="061c8-121">Pokud se nezdaří zařazení PSPE, by měl správce prostředků místo toho zařazení pomocí <xref:System.Transactions.Transaction.EnlistDurable%2A> metody.</span><span class="sxs-lookup"><span data-stu-id="061c8-121">If the PSPE enlistment fails, the RM should instead enlist using the <xref:System.Transactions.Transaction.EnlistDurable%2A> method.</span></span> <span data-ttu-id="061c8-122">Selhání při zařazení v PSPE může dojít, když transakce je již distribuovaných transakcí, nebo když PSPE zařazení již provedl jiný správce prostředků</span><span class="sxs-lookup"><span data-stu-id="061c8-122">Failures to enlist in PSPE might happen when the transaction is already a distributed transaction, or when another RM has already performed a PSPE enlistment</span></span>

<span data-ttu-id="061c8-123">Jakmile je zapsán, volá klienty potvrzení nebo přerušení <xref:System.Transactions> transakce jsou převedeny na volání na správce prostředků vyvoláním <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> v případě metody nebo <xref:System.Transactions.IPromotableSinglePhaseNotification.Rollback%2A> v uvedeném pořadí.</span><span class="sxs-lookup"><span data-stu-id="061c8-123">Once enlisted, calls by clients to commit or abort the <xref:System.Transactions> transaction are converted to calls on the Resource Manager by invoking the <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> method, or the <xref:System.Transactions.IPromotableSinglePhaseNotification.Rollback%2A> respectively.</span></span>

<span data-ttu-id="061c8-124">Pokud <xref:System.Transactions> transakce nikdy vyžaduje eskalace, když je transakce potvrzeny, obdrží správce prostředků <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> oznámení.</span><span class="sxs-lookup"><span data-stu-id="061c8-124">If the <xref:System.Transactions> transaction never requires escalation, when the transaction is committed, the RM receives a <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> notification.</span></span> <span data-ttu-id="061c8-125">Poté jej lze potvrďte interní transakce, která byla původně vytvořena.</span><span class="sxs-lookup"><span data-stu-id="061c8-125">It can then commit the internal transaction that was initially created.</span></span>

<span data-ttu-id="061c8-126">Pokud <xref:System.Transactions> transakce musí být eskalován (například pro podporu více RMs), <xref:System.Transactions> oznámí správci prostředků voláním <xref:System.Transactions.ITransactionPromoter.Promote%2A> metodu na <xref:System.Transactions.ITransactionPromoter> rozhraní, ze kterého <xref:System.Transactions.IPromotableSinglePhaseNotification> rozhraní je odvozena.</span><span class="sxs-lookup"><span data-stu-id="061c8-126">If the <xref:System.Transactions> transaction needs to be escalated (e.g., to support multiple RMs), <xref:System.Transactions> informs the resource manager by calling the <xref:System.Transactions.ITransactionPromoter.Promote%2A> method on the <xref:System.Transactions.ITransactionPromoter> interface, from which the <xref:System.Transactions.IPromotableSinglePhaseNotification> interface derives.</span></span> <span data-ttu-id="061c8-127">Správce prostředků potom převede transakce interně z místní transakce (která nevyžaduje protokolování) transakce objekt, který je schopen účasti na transakci DTC a přidruží ji k práci prováděné.</span><span class="sxs-lookup"><span data-stu-id="061c8-127">The resource manager then converts the transaction internally from a local transaction (which does not require logging) to a transaction object that is capable of participating in a DTC transaction, and associates it with the work already done.</span></span> <span data-ttu-id="061c8-128">Při transakci je vyzván k potvrzení, správce transakcí stále odešle <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> oznámení, aby správce zdrojů, který potvrdí distribuovaných transakcí, který je vytvořen při eskalace.</span><span class="sxs-lookup"><span data-stu-id="061c8-128">When the transaction is asked to commit, the transaction manager still sends the <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> notification to the resource manager, which commits the distributed transaction that it created during escalation.</span></span>

> [!NOTE]
> <span data-ttu-id="061c8-129">Trasování **TransactionCommitted** (které jsou generovány při vyvolání potvrzení pro eskalaci transakce) obsahují ID aktivity transakce DTC.</span><span class="sxs-lookup"><span data-stu-id="061c8-129">The **TransactionCommitted** traces (that are generated when a Commit is invoked on the escalated transaction) contain the activity ID of the DTC transaction.</span></span>

<span data-ttu-id="061c8-130">Další informace o eskalaci správy najdete v tématu [Eskalace správy transakcí](transaction-management-escalation.md).</span><span class="sxs-lookup"><span data-stu-id="061c8-130">For more information on management escalation, see [Transaction Management Escalation](transaction-management-escalation.md).</span></span>

## <a name="transaction-management-escalation-scenario"></a><span data-ttu-id="061c8-131">Eskalace scénář pro správu transakce</span><span class="sxs-lookup"><span data-stu-id="061c8-131">Transaction Management Escalation Scenario</span></span>

<span data-ttu-id="061c8-132">Následující scénář ukazuje eskalaci distribuovaných transakcí pomocí <xref:System.Data> oboru názvů jako proxy "server" pro správce prostředků.</span><span class="sxs-lookup"><span data-stu-id="061c8-132">The following scenario demonstrates an escalation to a distributed transaction using the <xref:System.Data> namespace as the ‘proxy’ for the resource manager.</span></span> <span data-ttu-id="061c8-133">Tento scénář předpokládá, že již existuje jedna <xref:System.Data> připojení k databázi, CN1, jejich zapojení do transakce a aplikace chce zahrnovat další <xref:System.Data> připojení, CN2.</span><span class="sxs-lookup"><span data-stu-id="061c8-133">This scenario assumes that there is already one <xref:System.Data> connection to the database, CN1, involved in the transaction, and the application wants to involve another <xref:System.Data> connection, CN2.</span></span> <span data-ttu-id="061c8-134">Transakce musí být rozšířena na DTC, jako dvoufázového úplná distribuované transakce.</span><span class="sxs-lookup"><span data-stu-id="061c8-134">The transaction must be escalated to DTC, as a full distributed two-phase commit transaction.</span></span>

<span data-ttu-id="061c8-135">V tomto případě</span><span class="sxs-lookup"><span data-stu-id="061c8-135">In this scenario,</span></span>

1. <span data-ttu-id="061c8-136">Volání CN1 <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> metodu za účelem zařadit do transakce.</span><span class="sxs-lookup"><span data-stu-id="061c8-136">CN1 calls the <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> method to enlist in the transaction.</span></span> <span data-ttu-id="061c8-137">Potom transakce je stále místní a neexistují žádné další možné zařazení transakce, takže se <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> volání úspěšné.</span><span class="sxs-lookup"><span data-stu-id="061c8-137">Then, the transaction is still local and there are no other promotable enlistments on the transaction, so the <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> call succeeds.</span></span>

2. <span data-ttu-id="061c8-138">Při volání CN2 druhé připojení <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A>, volání selže, protože je potřebný další možné zařazení.</span><span class="sxs-lookup"><span data-stu-id="061c8-138">When the second connection, CN2 calls <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A>, the call fails because there is another promotable enlistment involved.</span></span> <span data-ttu-id="061c8-139">Z tohoto důvodu musí CN2 získat transakci DTC, chcete-li předat SQL.</span><span class="sxs-lookup"><span data-stu-id="061c8-139">Because of this, CN2 must get a DTC transaction in order to pass it to SQL.</span></span> <span data-ttu-id="061c8-140">Chcete-li to provést, používá jednu z metody poskytované <xref:System.Transactions.TransactionInterop> třídy a vytvořit formát transakce, která mohou být zadány SQL.</span><span class="sxs-lookup"><span data-stu-id="061c8-140">To do this, it uses one of the methods provided by the <xref:System.Transactions.TransactionInterop> class to produce a format of the transaction that can be given to SQL.</span></span>

3. <span data-ttu-id="061c8-141"><xref:System.Transactions>volá <xref:System.Transactions.ITransactionPromoter.Promote%2A> metodu na <xref:System.Transactions.ITransactionPromoter> rozhraní implementované CN1.</span><span class="sxs-lookup"><span data-stu-id="061c8-141"><xref:System.Transactions> calls the <xref:System.Transactions.ITransactionPromoter.Promote%2A> method on the <xref:System.Transactions.ITransactionPromoter> interface implemented by CN1.</span></span>

4. <span data-ttu-id="061c8-142">V tomto okamžiku CN1 eskaluje transakce, pomocí některé mechanismus, které jsou specifické pro SQL 2005 a <xref:System.Data>.</span><span class="sxs-lookup"><span data-stu-id="061c8-142">At this point, CN1 escalates the transaction, using some mechanism specific to SQL 2005 and <xref:System.Data>.</span></span>

5. <span data-ttu-id="061c8-143">Návratová hodnota z <xref:System.Transactions.ITransactionPromoter.Promote%2A> je metoda bajtové pole, který obsahuje token šíření hodnoty pro transakci.</span><span class="sxs-lookup"><span data-stu-id="061c8-143">The return value from the <xref:System.Transactions.ITransactionPromoter.Promote%2A> method is a byte array that contains a propagation token for the transaction.</span></span> <span data-ttu-id="061c8-144"><xref:System.Transactions>pomocí tohoto tokenu šíření vytvoří transakci DTC, kterou může začlenit do místní transakce.</span><span class="sxs-lookup"><span data-stu-id="061c8-144"><xref:System.Transactions> uses this propagation token to create a DTC transaction that it can incorporate into the local transaction.</span></span>

6. <span data-ttu-id="061c8-145">V tomto okamžiku CN2 můžete použít data byla přijata z jedné z metod ve volání <xref:System.Transactions.TransactionInterop> mají být předány transakce SQL.</span><span class="sxs-lookup"><span data-stu-id="061c8-145">At this point, CN2 can use the data received from calling one of the methods by <xref:System.Transactions.TransactionInterop> to pass the transaction to SQL.</span></span>

7. <span data-ttu-id="061c8-146">Nyní jak jsou uveden v transakci DTC distribuované.</span><span class="sxs-lookup"><span data-stu-id="061c8-146">Now, both are enlisted in a DTC distributed transaction.</span></span>

## <a name="single-phase-commit-optimization"></a><span data-ttu-id="061c8-147">Optimalizace potvrzení jedna fáze</span><span class="sxs-lookup"><span data-stu-id="061c8-147">Single Phase Commit Optimization</span></span>

<span data-ttu-id="061c8-148">Protokol potvrzení jedné fáze je efektivnější za běhu jako všechny aktualizace jsou provedeno bez explicitního koordinace.</span><span class="sxs-lookup"><span data-stu-id="061c8-148">The Single Phase Commit protocol is more efficient at runtime as all updates are done without any explicit coordination.</span></span> <span data-ttu-id="061c8-149">Chcete-li využít výhod této optimalizace, měli byste implementovat pomocí Správce prostředků <xref:System.Transactions.ISinglePhaseNotification> rozhraní pro daný prostředek a zařadit do transakce pomocí <xref:System.Transactions.Transaction.EnlistDurable%2A> nebo <xref:System.Transactions.Transaction.EnlistVolatile%2A> metody.</span><span class="sxs-lookup"><span data-stu-id="061c8-149">To take advantage of this optimization, you should implement a resource manager using <xref:System.Transactions.ISinglePhaseNotification> interface for the resource and enlist in a transaction using the <xref:System.Transactions.Transaction.EnlistDurable%2A> or <xref:System.Transactions.Transaction.EnlistVolatile%2A> method.</span></span> <span data-ttu-id="061c8-150">Konkrétně by parametr *EnlistmentOptions* měl <xref:System.Transactions.EnlistmentOptions.None> být roven tomu, aby bylo zajištěno provedení jediné fáze potvrzení.</span><span class="sxs-lookup"><span data-stu-id="061c8-150">Specifically, the *EnlistmentOptions* parameter should equal to <xref:System.Transactions.EnlistmentOptions.None> to ensure that a single phase commit would be performed.</span></span>

<span data-ttu-id="061c8-151">Vzhledem k tomu <xref:System.Transactions.ISinglePhaseNotification> rozhraní je odvozena z <xref:System.Transactions.IEnlistmentNotification> rozhraní, není-li váš správce prostředků nárok na jediné fázi potvrzení, pak může i nadále přijímat dvě fáze potvrzení oznámení.</span><span class="sxs-lookup"><span data-stu-id="061c8-151">Since the <xref:System.Transactions.ISinglePhaseNotification> interface derives from the <xref:System.Transactions.IEnlistmentNotification> interface, if your RM is not eligible for single phase commit, it can still receive the two phase commit notifications.</span></span> <span data-ttu-id="061c8-152">Pokud váš správce prostředků přijme <xref:System.Transactions.ISinglePhaseNotification.SinglePhaseCommit%2A> oznámení ze Správce TM, by měl akci k provedení práce, které jsou nezbytné k potvrzení a odpovídajícím způsobem informovat správce transakcí, pokud má být potvrzena nebo vrácena zpět voláním transakce <xref:System.Transactions.SinglePhaseEnlistment.Committed%2A>, <xref:System.Transactions.SinglePhaseEnlistment.Aborted%2A>, nebo <xref:System.Transactions.SinglePhaseEnlistment.InDoubt%2A> metodu na <xref:System.Transactions.SinglePhaseEnlistment> parametru.</span><span class="sxs-lookup"><span data-stu-id="061c8-152">If your RM receives a <xref:System.Transactions.ISinglePhaseNotification.SinglePhaseCommit%2A> notification from the TM, it should try to do the work necessary for it to commit and correspondingly inform the transaction manager if the transaction is to be committed or rolled back by calling the <xref:System.Transactions.SinglePhaseEnlistment.Committed%2A>, <xref:System.Transactions.SinglePhaseEnlistment.Aborted%2A>, or <xref:System.Transactions.SinglePhaseEnlistment.InDoubt%2A> method on the <xref:System.Transactions.SinglePhaseEnlistment> parameter.</span></span> <span data-ttu-id="061c8-153">Odpověď <xref:System.Transactions.Enlistment.Done%2A> na zařazení v této fázi zahrnuje sémantiku jen pro čtení.</span><span class="sxs-lookup"><span data-stu-id="061c8-153">A response of <xref:System.Transactions.Enlistment.Done%2A> on the enlistment at this stage implies ReadOnly semantics.</span></span> <span data-ttu-id="061c8-154">Proto by neměl Odpovědět <xref:System.Transactions.Enlistment.Done%2A> spolu s některou z ostatních metod.</span><span class="sxs-lookup"><span data-stu-id="061c8-154">Therefore, you should not reply <xref:System.Transactions.Enlistment.Done%2A> in addition to any of the other methods.</span></span>

<span data-ttu-id="061c8-155">Pokud je k dispozici pouze jedno nestálé zařazení a žádné trvalé zařazení, nestálá zařazení obdrží oznámení SPC.</span><span class="sxs-lookup"><span data-stu-id="061c8-155">If there is only one volatile enlistment and no durable enlistment, the volatile enlistment receives SPC notification.</span></span> <span data-ttu-id="061c8-156">Pokud existují nějaké nestálé zařazení a jenom jedno trvalé zařazení, nestálá zařazení získají 2PC.</span><span class="sxs-lookup"><span data-stu-id="061c8-156">If there are any volatile enlistments and only one durable enlistment, the volatile enlistments receive 2PC.</span></span> <span data-ttu-id="061c8-157">Po dokončení, trvalý zařazení obdrží certifikát SPC.</span><span class="sxs-lookup"><span data-stu-id="061c8-157">When it is completed, the durable enlistment receives SPC.</span></span>

## <a name="see-also"></a><span data-ttu-id="061c8-158">Viz také</span><span class="sxs-lookup"><span data-stu-id="061c8-158">See also</span></span>

- [<span data-ttu-id="061c8-159">Uvedení prostředků jako účastníků v transakci</span><span class="sxs-lookup"><span data-stu-id="061c8-159">Enlisting Resources as Participants in a Transaction</span></span>](enlisting-resources-as-participants-in-a-transaction.md)
- [<span data-ttu-id="061c8-160">Potvrzení transakce v jedné fázi a více fázích</span><span class="sxs-lookup"><span data-stu-id="061c8-160">Committing a Transaction in Single-Phase and Multi-Phase</span></span>](committing-a-transaction-in-single-phase-and-multi-phase.md)
