---
title: Ukázka zabezpečení zjišťování
ms.date: 03/30/2017
ms.assetid: b8db01f4-b4a1-43fe-8e31-26d4e9304a65
ms.openlocfilehash: c6ec9b7e13234b7dae03541eb09ccba98f4cc93a
ms.sourcegitcommit: ee5b798427f81237a3c23d1fd81fff7fdc21e8d3
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 05/28/2020
ms.locfileid: "84144900"
---
# <a name="discovery-security-sample"></a><span data-ttu-id="d8da3-102">Ukázka zabezpečení zjišťování</span><span class="sxs-lookup"><span data-stu-id="d8da3-102">Discovery Security Sample</span></span>

<span data-ttu-id="d8da3-103">Specifikace zjišťování nevyžaduje, aby koncové body, které jsou součástí procesu zjišťování, byly zabezpečené.</span><span class="sxs-lookup"><span data-stu-id="d8da3-103">The Discovery specification does not require that endpoints that participate in the discovery process to be secure.</span></span> <span data-ttu-id="d8da3-104">Zvýšením počtu zpráv zjišťování se zabezpečením sníží riziko různých typů útoků (Změna zprávy, odmítnutí služby, opětovné přehrání, falšování identity).</span><span class="sxs-lookup"><span data-stu-id="d8da3-104">Enhancing the discovery messages with security mitigates various types of attacks (message alteration, denial of service, replay, spoofing).</span></span> <span data-ttu-id="d8da3-105">Tato ukázka implementuje vlastní kanály, které počítají a ověřují signatury zpráv pomocí formátu kompaktního podpisu (popsaného v části 8,2 specifikace WS-Discovery).</span><span class="sxs-lookup"><span data-stu-id="d8da3-105">This sample implements custom channels that compute and verify message signatures using the compact signature format (described in Section 8.2 of the WS-Discovery specification).</span></span> <span data-ttu-id="d8da3-106">Ukázka podporuje [specifikaci zjišťování 2005](http://specs.xmlsoap.org/ws/2005/04/discovery/ws-discovery.pdf) i [verzi 1,1](http://docs.oasis-open.org/ws-dd/discovery/1.1/cs-01/wsdd-discovery-1.1-spec-cs-01.pdf).</span><span class="sxs-lookup"><span data-stu-id="d8da3-106">The sample supports both the [2005 Discovery specification](http://specs.xmlsoap.org/ws/2005/04/discovery/ws-discovery.pdf) and the [1.1 version](http://docs.oasis-open.org/ws-dd/discovery/1.1/cs-01/wsdd-discovery-1.1-spec-cs-01.pdf).</span></span>  
  
 <span data-ttu-id="d8da3-107">Vlastní kanál se použije na začátku existujícího zásobníku kanálů pro zjišťování a koncové body oznámení.</span><span class="sxs-lookup"><span data-stu-id="d8da3-107">The custom channel is applied on top of the existing channel stack for Discovery and Announcement endpoints.</span></span> <span data-ttu-id="d8da3-108">Tímto způsobem se pro každou odeslanou zprávu použije záhlaví podpisu.</span><span class="sxs-lookup"><span data-stu-id="d8da3-108">This way, a signature header is applied for every message sent.</span></span> <span data-ttu-id="d8da3-109">Podpis se ověřuje u přijatých zpráv, a pokud se neshoduje nebo pokud zprávy nemají podpis, zprávy se zahozeny.</span><span class="sxs-lookup"><span data-stu-id="d8da3-109">The signature is verified on received messages and when it does not match or when the messages do not have a signature, the messages are dropped.</span></span> <span data-ttu-id="d8da3-110">Ukázka používá certifikáty, aby bylo možné podepsat a ověřit zprávy.</span><span class="sxs-lookup"><span data-stu-id="d8da3-110">To sign and verify messages, the sample uses certificates.</span></span>  
  
## <a name="discussion"></a><span data-ttu-id="d8da3-111">Účely</span><span class="sxs-lookup"><span data-stu-id="d8da3-111">Discussion</span></span>  
 <span data-ttu-id="d8da3-112">WCF je rozšiřitelné a umožňuje uživatelům přizpůsobit kanály podle potřeby.</span><span class="sxs-lookup"><span data-stu-id="d8da3-112">WCF is extensible and allows users the possibility to customize channels as desired.</span></span> <span data-ttu-id="d8da3-113">Ukázka implementuje zabezpečený prvek vazby zjišťování, který vytváří zabezpečené kanály.</span><span class="sxs-lookup"><span data-stu-id="d8da3-113">The sample implements a discovery secure binding element that builds secure channels.</span></span> <span data-ttu-id="d8da3-114">Zabezpečené kanály používají a ověřují podpisy zpráv a jsou použity na začátku aktuálního zásobníku.</span><span class="sxs-lookup"><span data-stu-id="d8da3-114">The secure channels apply and verify message signatures and are applied on top of the current stack.</span></span>  
  
 <span data-ttu-id="d8da3-115">Element Secure Binding vytváří objekty pro vytváření zabezpečených kanálů a naslouchací procesy kanálu.</span><span class="sxs-lookup"><span data-stu-id="d8da3-115">The secure binding element builds secure channel factories and channel listeners.</span></span>  
  
## <a name="secure-channel-factory"></a><span data-ttu-id="d8da3-116">Objekt pro vytváření zabezpečeného kanálu</span><span class="sxs-lookup"><span data-stu-id="d8da3-116">Secure Channel Factory</span></span>  
 <span data-ttu-id="d8da3-117">Objekt pro vytváření zabezpečeného kanálu vytváří výstupní nebo duplexní kanály, které přidávají kompaktní podpis do záhlaví zpráv.</span><span class="sxs-lookup"><span data-stu-id="d8da3-117">The secure channel factory creates output or duplex channels that add a compact signature to message headers.</span></span> <span data-ttu-id="d8da3-118">Chcete-li zachovat zprávy co nejmenším možným způsobem, je použit formát kompaktního podpisu.</span><span class="sxs-lookup"><span data-stu-id="d8da3-118">To keep messages as small as possible the compact signature format is used.</span></span> <span data-ttu-id="d8da3-119">V následujícím příkladu je uvedena struktura kompaktního podpisu.</span><span class="sxs-lookup"><span data-stu-id="d8da3-119">The structure of a compact signature is shown in the following example.</span></span>  
  
```xml  
<d:Security ... >
  [<d:Sig Scheme="xs:anyURI"
         [KeyId="xs:base64Binary"]?  
          Refs="..."  
         [PrefixList]="xs:NMTOKENS"
          Sig="xs:base64Binary"
          ... />]?  
  ...
</d:Security>  
```  
  
> [!NOTE]
> <span data-ttu-id="d8da3-120">`PrefixList`Byla přidána do protokolu verze zjišťování 2008.</span><span class="sxs-lookup"><span data-stu-id="d8da3-120">The `PrefixList` was added in the 2008 Discovery version protocol.</span></span>  
  
 <span data-ttu-id="d8da3-121">Pro výpočet podpisu ukázka určuje rozšířené položky podpisu.</span><span class="sxs-lookup"><span data-stu-id="d8da3-121">To compute the signature, the sample determines the expanded signature items.</span></span> <span data-ttu-id="d8da3-122">Signatura XML ( `SignedInfo` ) se vytvoří pomocí `ds` předpony oboru názvů, jak vyžaduje specifikace WS-Discovery.</span><span class="sxs-lookup"><span data-stu-id="d8da3-122">An XML signature (`SignedInfo`) is created, using the `ds` namespace prefix, as required by the WS-Discovery specification.</span></span> <span data-ttu-id="d8da3-123">V podpisu je odkazováno tělo a všechny hlavičky v názvech oborů zjišťování a adresování, takže je nelze považovat za neoprávněně.</span><span class="sxs-lookup"><span data-stu-id="d8da3-123">The body and all the headers in discovery and addressing namespaces are referenced in the signature, so they cannot be tampered with.</span></span> <span data-ttu-id="d8da3-124">Každý odkazovaný element je transformován pomocí exkluzivního kanonikalizace ( <http://www.w3.org/2001/10/xml-exc-c14n#> ) a pak je vypočítána hodnota digest SHA-1 ( <http://www.w3.org/2000/09/xmldsig#sha1> ).</span><span class="sxs-lookup"><span data-stu-id="d8da3-124">Each referenced element is transformed using the Exclusive Canonicalization (<http://www.w3.org/2001/10/xml-exc-c14n#>), and then an SHA-1 digest value is computed (<http://www.w3.org/2000/09/xmldsig#sha1>).</span></span> <span data-ttu-id="d8da3-125">V závislosti na všech odkazovaných prvcích a jejich hodnotách Digest se hodnota signatury vypočítá pomocí algoritmu RSA ( <http://www.w3.org/2000/09/xmldsig#rsa-sha1> ).</span><span class="sxs-lookup"><span data-stu-id="d8da3-125">Based on all referenced elements and their digest values, the signature value is computed using the RSA algorithm (<http://www.w3.org/2000/09/xmldsig#rsa-sha1>).</span></span>  
  
 <span data-ttu-id="d8da3-126">Zprávy jsou podepsány pomocí certifikátu zadaného klientem.</span><span class="sxs-lookup"><span data-stu-id="d8da3-126">The messages are signed with a client-specified certificate.</span></span> <span data-ttu-id="d8da3-127">Při vytvoření prvku vazby je nutné zadat název subjektu, název a certifikát umístění úložiště.</span><span class="sxs-lookup"><span data-stu-id="d8da3-127">The store location, name, and certificate subject name must be specified when the binding element is created.</span></span> <span data-ttu-id="d8da3-128">`KeyId`V kompaktním podpisu představuje identifikátor klíče podpisového tokenu, který je identifikátorem klíče subjektu (Ski) podpisového tokenu, nebo (Pokud není k dispozici) hodnota hash SHA-1 veřejného klíče podpisového tokenu.</span><span class="sxs-lookup"><span data-stu-id="d8da3-128">The `KeyId` in the compact signature represents the key identifier of the signing token and is the Subject Key Identifier (SKI) of the signing token or (if the SKI does not exist) a SHA-1 hash of the public key of the signing token.</span></span>  
  
## <a name="secure-channel-listener"></a><span data-ttu-id="d8da3-129">Naslouchací proces zabezpečeného kanálu</span><span class="sxs-lookup"><span data-stu-id="d8da3-129">Secure Channel Listener</span></span>  
 <span data-ttu-id="d8da3-130">Naslouchací proces zabezpečeného kanálu vytváří vstupní nebo duplexní kanály, které ověřují kompaktní podpis v přijatých zprávách.</span><span class="sxs-lookup"><span data-stu-id="d8da3-130">The secure channel listener creates input or duplex channels that verify the compact signature in received messages.</span></span> <span data-ttu-id="d8da3-131">Chcete-li ověřit podpis, `KeyId` je k výběru certifikátu ze zadaného úložiště použit parametr zadaný v kompaktním podpisu připojeném ke zprávě.</span><span class="sxs-lookup"><span data-stu-id="d8da3-131">To verify the signature, the `KeyId` specified in the compact signature attached to the message is used to select a certificate from the specified store.</span></span> <span data-ttu-id="d8da3-132">Pokud zpráva nemá podpis nebo se její podpis nepovede, jsou zprávy vyřazené.</span><span class="sxs-lookup"><span data-stu-id="d8da3-132">If the message does not have a signature or the signature check fails, the messages are dropped.</span></span> <span data-ttu-id="d8da3-133">Chcete-li použít zabezpečenou vazbu, ukázka definuje objekt pro vytváření, který vytvoří vlastní <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> a <xref:System.ServiceModel.Discovery.UdpAnnouncementEndpoint> s přidaným prvkem zabezpečené vazby zjišťování.</span><span class="sxs-lookup"><span data-stu-id="d8da3-133">To use the secure binding, the sample defines a factory that creates custom <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> and <xref:System.ServiceModel.Discovery.UdpAnnouncementEndpoint> with the added discovery secure binding element.</span></span> <span data-ttu-id="d8da3-134">Tyto zabezpečené koncové body lze použít v posluchačích oznámení zjišťování a zjistitelných službách.</span><span class="sxs-lookup"><span data-stu-id="d8da3-134">These secure endpoints can be used in discovery announcement listeners and discoverable services.</span></span>  
  
## <a name="sample-details"></a><span data-ttu-id="d8da3-135">Podrobnosti ukázky</span><span class="sxs-lookup"><span data-stu-id="d8da3-135">Sample Details</span></span>  
 <span data-ttu-id="d8da3-136">Ukázka zahrnuje knihovny a 4 konzolové aplikace:</span><span class="sxs-lookup"><span data-stu-id="d8da3-136">The sample includes a library and 4 console applications:</span></span>
  
- <span data-ttu-id="d8da3-137">**DiscoverySecurityChannels**: knihovna, která zveřejňuje zabezpečenou vazbu.</span><span class="sxs-lookup"><span data-stu-id="d8da3-137">**DiscoverySecurityChannels**: A library that exposes the secure binding.</span></span> <span data-ttu-id="d8da3-138">Knihovna vypočítá a ověří kompaktní podpis pro odchozí a příchozí zprávy.</span><span class="sxs-lookup"><span data-stu-id="d8da3-138">The library computes and verifies the compact signature for outgoing/incoming messages.</span></span>  
  
- <span data-ttu-id="d8da3-139">**Služba**: služba, která zveřejňuje kontrakt ICalculatorService, který je hostovaný v místním prostředí.</span><span class="sxs-lookup"><span data-stu-id="d8da3-139">**Service**: A service exposing ICalculatorService contract, self hosted.</span></span> <span data-ttu-id="d8da3-140">Služba je označená jako zjistitelná.</span><span class="sxs-lookup"><span data-stu-id="d8da3-140">The service is marked as Discoverable.</span></span> <span data-ttu-id="d8da3-141">Uživatel Určuje podrobnosti certifikátu používaného k podepisování zpráv zadáním umístění úložiště a názvu subjektu nebo jiného jedinečného identifikátoru pro certifikát a úložištěm, kde jsou umístěny klientské certifikáty (certifikáty používané pro kontrolu podpisu příchozích zpráv).</span><span class="sxs-lookup"><span data-stu-id="d8da3-141">The user specifies the details of the certificate used to sign messages by specifying the store location and name and the subject name or other unique identifier for the certificate, and the store where the client certificates are located (the certificates used to check signature for incoming messages).</span></span> <span data-ttu-id="d8da3-142">Na základě těchto informací se sestaví a použije UdpDiscoveryEndpoint s přidaným zabezpečením.</span><span class="sxs-lookup"><span data-stu-id="d8da3-142">Based on these details, a UdpDiscoveryEndpoint with added security is built and used.</span></span>  
  
- <span data-ttu-id="d8da3-143">**Klient**: Tato třída se pokusí zjistit ICalculatorService a volat metody ve službě.</span><span class="sxs-lookup"><span data-stu-id="d8da3-143">**Client**: This class tries to discover an ICalculatorService and to call methods on the service.</span></span> <span data-ttu-id="d8da3-144">Znovu se vytvoří <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> a s přidaným zabezpečením se sestaví a použije k podepsání a ověření zpráv.</span><span class="sxs-lookup"><span data-stu-id="d8da3-144">Again, a <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> with added security is built and used to sign and verify the messages.</span></span>  
  
- <span data-ttu-id="d8da3-145">**AnnouncementListener**: Samoobslužná služba, která naslouchá online a offline oznámením a používá koncový bod zabezpečeného oznámení.</span><span class="sxs-lookup"><span data-stu-id="d8da3-145">**AnnouncementListener**: A self-hosted service that listens for online and offline announcements and uses the secure announcement endpoint.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="d8da3-146">Pokud se instalační program. bat spustí víckrát, správce certifikátů vás vyzve k výběru certifikátu, který se má přidat, protože jsou k dispozici duplicitní certifikáty.</span><span class="sxs-lookup"><span data-stu-id="d8da3-146">If Setup.bat is run multiple times, the certificate manager prompts you for choosing a certificate to add, as there are duplicate certificates.</span></span> <span data-ttu-id="d8da3-147">V takovém případě by měl být Setup. bat přerušen a měl by být volán program Cleanup. bat, protože duplicity již byly vytvořeny.</span><span class="sxs-lookup"><span data-stu-id="d8da3-147">In that case, Setup.bat should be aborted and Cleanup.bat should be called, because the duplicates have already been created.</span></span> <span data-ttu-id="d8da3-148">Vyčištění. bat vás také vyzve k výběru certifikátu, který chcete odstranit.</span><span class="sxs-lookup"><span data-stu-id="d8da3-148">Cleanup.bat also prompts you to choose a certificate to delete.</span></span> <span data-ttu-id="d8da3-149">Vyberte certifikát ze seznamu a pokračujte v provádění nástroje CleanUp. bat, dokud nebudou žádné certifikáty zbývající.</span><span class="sxs-lookup"><span data-stu-id="d8da3-149">Select a certificate from the list and continue executing Cleanup.bat until no certificates are remaining.</span></span>  
  
#### <a name="to-use-this-sample"></a><span data-ttu-id="d8da3-150">Použití této ukázky</span><span class="sxs-lookup"><span data-stu-id="d8da3-150">To use this sample</span></span>  
  
1. <span data-ttu-id="d8da3-151">Spusťte skript Setup. bat z Developer Command Prompt pro Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="d8da3-151">Execute the Setup.bat script from a Developer Command Prompt for Visual Studio.</span></span> <span data-ttu-id="d8da3-152">Ukázka používá certifikáty k podepisování a ověřování zpráv.</span><span class="sxs-lookup"><span data-stu-id="d8da3-152">The sample uses certificates to sign and verify messages.</span></span> <span data-ttu-id="d8da3-153">Skript vytvoří certifikáty pomocí nástroje MakeCert. exe a pak je nainstaluje pomocí nástroje Certmgr. exe.</span><span class="sxs-lookup"><span data-stu-id="d8da3-153">The script creates the certificates using Makecert.exe and then installs them using Certmgr.exe.</span></span> <span data-ttu-id="d8da3-154">Skript musí být spuštěn s oprávněními správce.</span><span class="sxs-lookup"><span data-stu-id="d8da3-154">The script must be run with administrator privileges.</span></span>  
  
2. <span data-ttu-id="d8da3-155">Chcete-li vytvořit a spustit ukázku, otevřete soubor Security. sln v aplikaci Visual Studio a vyberte možnost **znovu sestavit vše**.</span><span class="sxs-lookup"><span data-stu-id="d8da3-155">To build and run the sample, open the Security.sln file in Visual Studio and choose **Rebuild All**.</span></span> <span data-ttu-id="d8da3-156">Aktualizovat vlastnosti řešení, aby bylo možné spustit více projektů: vyberte možnost **Spustit** pro všechny projekty s výjimkou DiscoverySecureChannels.</span><span class="sxs-lookup"><span data-stu-id="d8da3-156">Update the solution properties to start multiple projects: select **Start** for all projects except DiscoverySecureChannels.</span></span> <span data-ttu-id="d8da3-157">Řešení spouštějte normálně.</span><span class="sxs-lookup"><span data-stu-id="d8da3-157">Run the solution normally.</span></span>  
  
3. <span data-ttu-id="d8da3-158">Až budete s ukázkou hotovi, spusťte skript Cleanup. bat, který odebere certifikáty vytvořené pro tuto ukázku.</span><span class="sxs-lookup"><span data-stu-id="d8da3-158">After you are done with the sample, execute the Cleanup.bat script that removes the certificates created for this sample.</span></span>  
  
> [!IMPORTANT]
> <span data-ttu-id="d8da3-159">Ukázky už můžou být na vašem počítači nainstalované.</span><span class="sxs-lookup"><span data-stu-id="d8da3-159">The samples may already be installed on your machine.</span></span> <span data-ttu-id="d8da3-160">Než budete pokračovat, vyhledejte následující (výchozí) adresář.</span><span class="sxs-lookup"><span data-stu-id="d8da3-160">Check for the following (default) directory before continuing.</span></span>  
>
> `<InstallDrive>:\WF_WCF_Samples`  
>
> <span data-ttu-id="d8da3-161">Pokud tento adresář neexistuje, přečtěte si [ukázky Windows Communication Foundation (WCF) a programovací model Windows Workflow Foundation (WF) pro .NET Framework 4](https://www.microsoft.com/download/details.aspx?id=21459) ke stažení všech Windows Communication Foundation (WCF) a [!INCLUDE[wf1](../../../../includes/wf1-md.md)] ukázek.</span><span class="sxs-lookup"><span data-stu-id="d8da3-161">If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://www.microsoft.com/download/details.aspx?id=21459) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples.</span></span> <span data-ttu-id="d8da3-162">Tato ukázka se nachází v následujícím adresáři.</span><span class="sxs-lookup"><span data-stu-id="d8da3-162">This sample is located in the following directory.</span></span>  
>
> `<InstallDrive>:\WF_WCF_Samples\WCF\Scenario\DiscoveryScenario`  
