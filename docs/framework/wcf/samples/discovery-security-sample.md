---
title: Ukázka zabezpečení zjišťování
ms.date: 03/30/2017
ms.assetid: b8db01f4-b4a1-43fe-8e31-26d4e9304a65
ms.openlocfilehash: 00f81d1879d9157a7ecdfa0db8d2ea0d505ad5b6
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 03/12/2020
ms.locfileid: "79183747"
---
# <a name="discovery-security-sample"></a><span data-ttu-id="e6493-102">Ukázka zabezpečení zjišťování</span><span class="sxs-lookup"><span data-stu-id="e6493-102">Discovery Security Sample</span></span>

<span data-ttu-id="e6493-103">Specifikace zjišťování nevyžaduje, aby koncové body, které se účastní procesu zjišťování, byly zabezpečené.</span><span class="sxs-lookup"><span data-stu-id="e6493-103">The Discovery specification does not require that endpoints that participate in the discovery process to be secure.</span></span> <span data-ttu-id="e6493-104">Vylepšení zjišťování zpráv se zabezpečením zmírňuje různé typy útoků (změna zprávy, odmítnutí služby, přehrání, falšování.</span><span class="sxs-lookup"><span data-stu-id="e6493-104">Enhancing the discovery messages with security mitigates various types of attacks (message alteration, denial of service, replay, spoofing).</span></span> <span data-ttu-id="e6493-105">Tato ukázka implementuje vlastní kanály, které počítají a ověřují podpisy zpráv pomocí formátu kompaktního podpisu (popsaného v části 8.2 specifikace WS-Discovery).</span><span class="sxs-lookup"><span data-stu-id="e6493-105">This sample implements custom channels that compute and verify message signatures using the compact signature format (described in Section 8.2 of the WS-Discovery specification).</span></span> <span data-ttu-id="e6493-106">Ukázka podporuje [jak specifikaci 2005 Discovery,](http://specs.xmlsoap.org/ws/2005/04/discovery/ws-discovery.pdf) tak [verzi 1.1](http://docs.oasis-open.org/ws-dd/discovery/1.1/cs-01/wsdd-discovery-1.1-spec-cs-01.pdf).</span><span class="sxs-lookup"><span data-stu-id="e6493-106">The sample supports both the [2005 Discovery specification](http://specs.xmlsoap.org/ws/2005/04/discovery/ws-discovery.pdf) and the [1.1 version](http://docs.oasis-open.org/ws-dd/discovery/1.1/cs-01/wsdd-discovery-1.1-spec-cs-01.pdf).</span></span>  
  
 <span data-ttu-id="e6493-107">Vlastní kanál se použije nad existující zásobník kanálu pro zjišťování a oznámení koncových bodů.</span><span class="sxs-lookup"><span data-stu-id="e6493-107">The custom channel is applied on top of the existing channel stack for Discovery and Announcement endpoints.</span></span> <span data-ttu-id="e6493-108">Tímto způsobem je záhlaví podpisu použito pro každou odeslanou zprávu.</span><span class="sxs-lookup"><span data-stu-id="e6493-108">This way, a signature header is applied for every message sent.</span></span> <span data-ttu-id="e6493-109">Podpis je ověřen na přijatých zprávách a pokud se neshoduje nebo pokud zprávy nemají podpis, jsou zprávy vynechány.</span><span class="sxs-lookup"><span data-stu-id="e6493-109">The signature is verified on received messages and when it does not match or when the messages do not have a signature, the messages are dropped.</span></span> <span data-ttu-id="e6493-110">K podepisování a ověřování zpráv používá ukázka certifikáty.</span><span class="sxs-lookup"><span data-stu-id="e6493-110">To sign and verify messages, the sample uses certificates.</span></span>  
  
## <a name="discussion"></a><span data-ttu-id="e6493-111">Diskuse</span><span class="sxs-lookup"><span data-stu-id="e6493-111">Discussion</span></span>  
 <span data-ttu-id="e6493-112">WCF je velmi rozšiřitelný a umožňuje uživatelům přizpůsobit kanály podle potřeby.</span><span class="sxs-lookup"><span data-stu-id="e6493-112">WCF is very extensible and allows users the possibility to customize channels as desired.</span></span> <span data-ttu-id="e6493-113">Ukázka implementuje zjišťování zabezpečené vazby element, který vytváří zabezpečené kanály.</span><span class="sxs-lookup"><span data-stu-id="e6493-113">The sample implements a discovery secure binding element that builds secure channels.</span></span> <span data-ttu-id="e6493-114">Zabezpečené kanály platí a ověřují podpisy zpráv a jsou použity nad aktuálním zásobníkem.</span><span class="sxs-lookup"><span data-stu-id="e6493-114">The secure channels apply and verify message signatures and are applied on top of the current stack.</span></span>  
  
 <span data-ttu-id="e6493-115">Prvek zabezpečené vazby vytváří zabezpečené kanály továrny a naslouchací procesy kanálu.</span><span class="sxs-lookup"><span data-stu-id="e6493-115">The secure binding element builds secure channel factories and channel listeners.</span></span>  
  
## <a name="secure-channel-factory"></a><span data-ttu-id="e6493-116">Továrna zabezpečeného kanálu</span><span class="sxs-lookup"><span data-stu-id="e6493-116">Secure Channel Factory</span></span>  
 <span data-ttu-id="e6493-117">Zabezpečená továrna kanálu vytvoří výstupní nebo duplexní kanály, které přidávají kompaktní podpis do záhlaví zpráv.</span><span class="sxs-lookup"><span data-stu-id="e6493-117">The secure channel factory creates output or duplex channels that add a compact signature to message headers.</span></span> <span data-ttu-id="e6493-118">Chcete-li zachovat zprávy co nejmenší, použije se formát kompaktního podpisu.</span><span class="sxs-lookup"><span data-stu-id="e6493-118">To keep messages as small as possible the compact signature format is used.</span></span> <span data-ttu-id="e6493-119">Struktura kompaktního podpisu je uvedena v následujícím příkladu.</span><span class="sxs-lookup"><span data-stu-id="e6493-119">The structure of a compact signature is shown in the following example.</span></span>  
  
```xml  
<d:Security ... >
  [<d:Sig Scheme="xs:anyURI"
         [KeyId="xs:base64Binary"]?  
          Refs="..."  
         [PrefixList]="xs:NMTOKENS"
          Sig="xs:base64Binary"
          ... />]?  
  ...
</d:Security>  
```  
  
> [!NOTE]
> <span data-ttu-id="e6493-120">Byl `PrefixList` přidán do protokolu verze Discovery 2008.</span><span class="sxs-lookup"><span data-stu-id="e6493-120">The `PrefixList` was added in the 2008 Discovery version protocol.</span></span>  
  
 <span data-ttu-id="e6493-121">Chcete-li vypočítat podpis, ukázka určuje rozbalené položky podpisu.</span><span class="sxs-lookup"><span data-stu-id="e6493-121">To compute the signature, the sample determines the expanded signature items.</span></span> <span data-ttu-id="e6493-122">Podpis XML`SignedInfo`( ) je `ds` vytvořen pomocí předpony oboru názvů, jak to vyžaduje specifikace WS-Discovery.</span><span class="sxs-lookup"><span data-stu-id="e6493-122">An XML signature (`SignedInfo`) is created, using the `ds` namespace prefix, as required by the WS-Discovery specification.</span></span> <span data-ttu-id="e6493-123">Tělo a všechny hlavičky v oborech názvů zjišťování a adresování jsou v podpisu odkazovány, takže s nimi nelze manipulovat.</span><span class="sxs-lookup"><span data-stu-id="e6493-123">The body and all the headers in discovery and addressing namespaces are referenced in the signature, so they cannot be tampered with.</span></span> <span data-ttu-id="e6493-124">Každý odkazovaný prvek je transformován pomocíhttp://www.w3.org/2001/10/xml-exc-c14n# exclusive canonicalization ( ) ahttp://www.w3.org/2000/09/xmldsig#sha1 pak je vypočítána hodnota digest SHA-1 ( ).</span><span class="sxs-lookup"><span data-stu-id="e6493-124">Each referenced element is transformed using the Exclusive Canonicalization (http://www.w3.org/2001/10/xml-exc-c14n# ), and then an SHA-1 digest value is computed (http://www.w3.org/2000/09/xmldsig#sha1 ).</span></span> <span data-ttu-id="e6493-125">Na základě všech odkazovaných prvků a jejich hodnot digest se vypočítáhttp://www.w3.org/2000/09/xmldsig#rsa-sha1 hodnota podpisu pomocí algoritmu RSA ( ).</span><span class="sxs-lookup"><span data-stu-id="e6493-125">Based on all referenced elements and their digest values, the signature value is computed using the RSA algorithm (http://www.w3.org/2000/09/xmldsig#rsa-sha1 ).</span></span>  
  
 <span data-ttu-id="e6493-126">Zprávy jsou podepsány certifikátem zadaným klientem.</span><span class="sxs-lookup"><span data-stu-id="e6493-126">The messages are signed with a client-specified certificate.</span></span> <span data-ttu-id="e6493-127">Umístění úložiště, název a název subjektu certifikátu musí být určeny při vytvoření prvku vazby.</span><span class="sxs-lookup"><span data-stu-id="e6493-127">The store location, name and the certificate subject name must be specified when the binding element is created.</span></span> <span data-ttu-id="e6493-128">`KeyId` V kompaktním podpisu představuje identifikátor klíče podpisového tokenu a je identifikátor klíče subjektu (SKI) podpisového tokenu nebo (pokud SKI neexistuje) algoritmus hash SHA-1 veřejného klíče podpisového tokenu.</span><span class="sxs-lookup"><span data-stu-id="e6493-128">The `KeyId` in the compact signature represents the key identifier of the signing token and is the Subject Key Identifier (SKI) of the signing token or (if the SKI does not exist) a SHA-1 hash of the public key of the signing token.</span></span>  
  
## <a name="secure-channel-listener"></a><span data-ttu-id="e6493-129">Naslouchací proces zabezpečeného kanálu</span><span class="sxs-lookup"><span data-stu-id="e6493-129">Secure Channel Listener</span></span>  
 <span data-ttu-id="e6493-130">Naslouchací proces zabezpečeného kanálu vytvoří vstupní nebo duplexní kanály, které ověřují kompaktní podpis v přijatých zprávách.</span><span class="sxs-lookup"><span data-stu-id="e6493-130">The secure channel listener creates input or duplex channels that verify the compact signature in received messages.</span></span> <span data-ttu-id="e6493-131">Chcete-li ověřit `KeyId` podpis, zadaný v kompaktním podpisu připojeném ke zprávě se používá k výběru certifikátu ze zadaného úložiště.</span><span class="sxs-lookup"><span data-stu-id="e6493-131">To verify the signature, the `KeyId` specified in the compact signature attached to the message is used to select a certificate from the specified store.</span></span> <span data-ttu-id="e6493-132">Pokud zpráva nemá podpis nebo se nezdaří kontrola podpisu, zprávy jsou vynechány.</span><span class="sxs-lookup"><span data-stu-id="e6493-132">If the message does not have a signature or the signature check fails, the messages are dropped.</span></span> <span data-ttu-id="e6493-133">Chcete-li použít zabezpečenou vazbu, ukázka definuje továrnu, která vytváří vlastní <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> a <xref:System.ServiceModel.Discovery.UdpAnnouncementEndpoint> s přidaným discovery secure vazby elementu.</span><span class="sxs-lookup"><span data-stu-id="e6493-133">To use the secure binding, the sample defines a factory that creates custom <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> and <xref:System.ServiceModel.Discovery.UdpAnnouncementEndpoint> with the added discovery secure binding element.</span></span> <span data-ttu-id="e6493-134">Tyto zabezpečené koncové body lze použít v posluchači oznámení zjišťování a zjistitelné služby.</span><span class="sxs-lookup"><span data-stu-id="e6493-134">These secure endpoints can be used in discovery announcement listeners and discoverable services.</span></span>  
  
## <a name="sample-details"></a><span data-ttu-id="e6493-135">Podrobnosti ukázky</span><span class="sxs-lookup"><span data-stu-id="e6493-135">Sample Details</span></span>  
 <span data-ttu-id="e6493-136">Ukázka obsahuje knihovnu a 4 konzolové aplikace:</span><span class="sxs-lookup"><span data-stu-id="e6493-136">The sample includes a library and 4 console applications:</span></span>  
  
- <span data-ttu-id="e6493-137">**DiscoverySecurityChannels**: Knihovna, která zveřejňuje zabezpečené vazby.</span><span class="sxs-lookup"><span data-stu-id="e6493-137">**DiscoverySecurityChannels**: A library that exposes the secure binding.</span></span> <span data-ttu-id="e6493-138">Knihovna vypočítá a ověří kompaktní podpis pro odchozí/příchozí zprávy.</span><span class="sxs-lookup"><span data-stu-id="e6493-138">The library computes and verifies the compact signature for outgoing/incoming messages.</span></span>  
  
- <span data-ttu-id="e6493-139">**Služba**: Služba odhalující smlouvu ICalculatorService, vlastní hostované.</span><span class="sxs-lookup"><span data-stu-id="e6493-139">**Service**: A service exposing ICalculatorService contract, self hosted.</span></span> <span data-ttu-id="e6493-140">Služba je označena jako zjistitelná.</span><span class="sxs-lookup"><span data-stu-id="e6493-140">The service is marked as Discoverable.</span></span> <span data-ttu-id="e6493-141">Uživatel specifikuje podrobnosti o certifikátu použitém k podepisování zpráv zadáním umístění úložiště a názvu úložiště a názvu subjektu nebo jiného jedinečného identifikátoru certifikátu a úložiště, kde jsou umístěny klientské certifikáty (certifikáty používané k zkontrolujte podpis pro příchozí zprávy).</span><span class="sxs-lookup"><span data-stu-id="e6493-141">The user specifies the details of the certificate used to sign messages by specifying the store location and name and the subject name or other unique identifier for the certificate, and the store where the client certificates are located (the certificates used to check signature for incoming messages).</span></span> <span data-ttu-id="e6493-142">Na základě těchto podrobností je vytvořen a používán udpDiscoveryEndpoint s přidaným zabezpečením.</span><span class="sxs-lookup"><span data-stu-id="e6493-142">Based on these details, a UdpDiscoveryEndpoint with added security is built and used.</span></span>  
  
- <span data-ttu-id="e6493-143">**Klient**: Tato třída se pokusí zjistit ICalculatorService a volat metody ve službě.</span><span class="sxs-lookup"><span data-stu-id="e6493-143">**Client**: This class tries to discover an ICalculatorService and to call methods on the service.</span></span> <span data-ttu-id="e6493-144">Opět platí, že s přidanou <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> zabezpečení je sestaven a slouží k podepisování a ověřování zpráv.</span><span class="sxs-lookup"><span data-stu-id="e6493-144">Again, a <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> with added security is built and used to sign and verify the messages.</span></span>  
  
- <span data-ttu-id="e6493-145">**AnnouncementListener**: Samoobslužná služba, která naslouchá oznámením online a offline a používá koncový bod zabezpečeného oznámení.</span><span class="sxs-lookup"><span data-stu-id="e6493-145">**AnnouncementListener**: A self-hosted service that listens for online and offline announcements and uses the secure announcement endpoint.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="e6493-146">Pokud je soubor Setup.bat spuštěn vícekrát, správce certifikátu vás vyzve k výběru certifikátu, který chcete přidat, protože existují duplicitní certifikáty.</span><span class="sxs-lookup"><span data-stu-id="e6493-146">If Setup.bat is run multiple times, the certificate manager prompts you for choosing a certificate to add, as there are duplicate certificates.</span></span> <span data-ttu-id="e6493-147">V takovém případě by měl být soubor Setup.bat přerušen a soubor Cleanup.bat by měl být volán, protože duplikáty již byly vytvořeny.</span><span class="sxs-lookup"><span data-stu-id="e6493-147">In that case, Setup.bat should be aborted and Cleanup.bat should be called, because the duplicates have already been created.</span></span> <span data-ttu-id="e6493-148">Cleanup.bat vás také vyzve k výběru certifikátu, který chcete odstranit.</span><span class="sxs-lookup"><span data-stu-id="e6493-148">Cleanup.bat also prompts you to choose a certificate to delete.</span></span> <span data-ttu-id="e6493-149">Vyberte certifikát ze seznamu a pokračujte ve provádění souboru Cleanup.bat, dokud nezůstanou žádné certifikáty.</span><span class="sxs-lookup"><span data-stu-id="e6493-149">Select a certificate from the list and continue executing Cleanup.bat until no certificates are remaining.</span></span>  
  
#### <a name="to-use-this-sample"></a><span data-ttu-id="e6493-150">Chcete-li použít tento vzorek</span><span class="sxs-lookup"><span data-stu-id="e6493-150">To use this sample</span></span>  
  
1. <span data-ttu-id="e6493-151">Spusťte skript Setup.bat z příkazového řádku pro vývojáře pro visual studio.</span><span class="sxs-lookup"><span data-stu-id="e6493-151">Execute the Setup.bat script from a Developer Command Prompt for Visual Studio.</span></span> <span data-ttu-id="e6493-152">Ukázka používá certifikáty k podepisování a ověřování zpráv.</span><span class="sxs-lookup"><span data-stu-id="e6493-152">The sample uses certificates to sign and verify messages.</span></span> <span data-ttu-id="e6493-153">Skript vytvoří certifikáty pomocí makecert.exe a potom je nainstaluje pomocí programu Certmgr.exe.</span><span class="sxs-lookup"><span data-stu-id="e6493-153">The script creates the certificates using Makecert.exe and then installs them using Certmgr.exe.</span></span> <span data-ttu-id="e6493-154">Skript musí být spuštěn s oprávněními správce.</span><span class="sxs-lookup"><span data-stu-id="e6493-154">The script must be run with administrator privileges.</span></span>  
  
2. <span data-ttu-id="e6493-155">Chcete-li vytvořit a spustit ukázku, otevřete soubor Security.sln v sadě Visual Studio a zvolte **Znovu sestavit vše**.</span><span class="sxs-lookup"><span data-stu-id="e6493-155">To build and run the sample, open the Security.sln file in Visual Studio and choose **Rebuild All**.</span></span> <span data-ttu-id="e6493-156">Aktualizujte vlastnosti řešení a spusťte více projektů: vyberte **Spustit** pro všechny projekty kromě DiscoverySecureChannels.</span><span class="sxs-lookup"><span data-stu-id="e6493-156">Update the solution properties to start multiple projects: select **Start** for all projects except DiscoverySecureChannels.</span></span> <span data-ttu-id="e6493-157">Spusťte řešení normálně.</span><span class="sxs-lookup"><span data-stu-id="e6493-157">Run the solution normally.</span></span>  
  
3. <span data-ttu-id="e6493-158">Po dokončení s ukázkou spusťte skript Cleanup.bat, který odebere certifikáty vytvořené pro tuto ukázku.</span><span class="sxs-lookup"><span data-stu-id="e6493-158">After you are done with the sample, execute the Cleanup.bat script that removes the certificates created for this sample.</span></span>  
  
> [!IMPORTANT]
> <span data-ttu-id="e6493-159">Ukázky mohou být již nainstalovány v počítači.</span><span class="sxs-lookup"><span data-stu-id="e6493-159">The samples may already be installed on your machine.</span></span> <span data-ttu-id="e6493-160">Před pokračováním zkontrolujte následující (výchozí) adresář.</span><span class="sxs-lookup"><span data-stu-id="e6493-160">Check for the following (default) directory before continuing.</span></span>  
>
> `<InstallDrive>:\WF_WCF_Samples`  
>
> <span data-ttu-id="e6493-161">Pokud tento adresář neexistuje, přejděte na [Windows Communication Foundation (WCF) a Windows Workflow Foundation (WF) Ukázky pro rozhraní .NET Framework 4](https://www.microsoft.com/download/details.aspx?id=21459) stáhnout všechny Windows Communication Foundation (WCF) a [!INCLUDE[wf1](../../../../includes/wf1-md.md)] ukázky.</span><span class="sxs-lookup"><span data-stu-id="e6493-161">If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://www.microsoft.com/download/details.aspx?id=21459) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples.</span></span> <span data-ttu-id="e6493-162">Tato ukázka je umístěna v následujícím adresáři.</span><span class="sxs-lookup"><span data-stu-id="e6493-162">This sample is located in the following directory.</span></span>  
>
> `<InstallDrive>:\WF_WCF_Samples\WCF\Scenario\DiscoveryScenario`  
