---
title: Dávkování zpráv v transakci
ms.date: 03/30/2017
helpviewer_keywords:
- batching messages [WCF]
ms.assetid: 53305392-e82e-4e89-aedc-3efb6ebcd28c
ms.openlocfilehash: be9661525c960ae558d21b05781007b81b8a3f56
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 03/12/2020
ms.locfileid: "79185441"
---
# <a name="batching-messages-in-a-transaction"></a><span data-ttu-id="9f4f3-102">Dávkování zpráv v transakci</span><span class="sxs-lookup"><span data-stu-id="9f4f3-102">Batching Messages in a Transaction</span></span>
<span data-ttu-id="9f4f3-103">Aplikace ve frontě používají transakce k zajištění správnosti a spolehlivého doručování zpráv.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-103">Queued applications use transactions to ensure correctness and reliable delivery of messages.</span></span> <span data-ttu-id="9f4f3-104">Transakce jsou však nákladné operace a může výrazně snížit propustnost zpráv.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-104">Transactions, however, are expensive operations and can dramatically reduce message throughput.</span></span> <span data-ttu-id="9f4f3-105">Jedním ze způsobů, jak zlepšit propustnost zpráv, je, aby aplikace četla a zpracovávala více zpráv v rámci jedné transakce.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-105">One way to improve message throughput is to have an application read and process multiple messages within a single transaction.</span></span> <span data-ttu-id="9f4f3-106">Kompromis je mezi výkonem a obnovení: jako počet zpráv v dávce zvyšuje, tak se množství práce obnovení, které vyžadují, pokud jsou transakce vráceny zpět.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-106">The trade-off is between performance and recovery: as the number of messages in a batch increases, so does the amount of recovery work that required if transactions are rolled back.</span></span> <span data-ttu-id="9f4f3-107">Je důležité si uvědomit rozdíl mezi dávkově zprávy v transakci a relace.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-107">It is important to note the difference between batching messages in a transaction and sessions.</span></span> <span data-ttu-id="9f4f3-108">*Relace* je seskupení souvisejících zpráv, které jsou zpracovány jednou aplikací a potvrzeny jako jedna jednotka.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-108">A *session* is a grouping of related messages that are processed by a single application and committed as a single unit.</span></span> <span data-ttu-id="9f4f3-109">Relace se obvykle používají, když skupina souvisejících zpráv musí být zpracována společně.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-109">Sessions are generally used when a group of related messages must be processed together.</span></span> <span data-ttu-id="9f4f3-110">Příkladem je web pro online nakupování.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-110">An example of this is an online shopping Web site.</span></span> <span data-ttu-id="9f4f3-111">*Listy* se používají ke zpracování více nesouvisejících zpráv způsobem, který zvyšuje propustnost zpráv.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-111">*Batches* are used to process multiple, unrelated messages in a way that increases message throughput.</span></span> <span data-ttu-id="9f4f3-112">Další informace o relacích naleznete [v tématu Seskupování zpráv ve frontě v relaci](../../../../docs/framework/wcf/feature-details/grouping-queued-messages-in-a-session.md).</span><span class="sxs-lookup"><span data-stu-id="9f4f3-112">For more information about sessions, see [Grouping Queued Messages in a Session](../../../../docs/framework/wcf/feature-details/grouping-queued-messages-in-a-session.md).</span></span> <span data-ttu-id="9f4f3-113">Zprávy v dávce jsou také zpracovány jednou aplikací a potvrzeny jako jedna jednotka, ale může existovat žádný vztah mezi zprávami v dávce.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-113">Messages in a batch are also processed by a single application and committed as a single unit, but there may be no relationship between the messages in the batch.</span></span> <span data-ttu-id="9f4f3-114">Dávkování zpráv v transakci je optimalizace, která nemění způsob, jakým aplikace běží.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-114">Batching messages in a transaction is an optimization that does not change how the application runs.</span></span>  
  
## <a name="entering-batching-mode"></a><span data-ttu-id="9f4f3-115">Zadání dávkovacího režimu</span><span class="sxs-lookup"><span data-stu-id="9f4f3-115">Entering Batching Mode</span></span>  
 <span data-ttu-id="9f4f3-116">Chování <xref:System.ServiceModel.Description.TransactedBatchingBehavior> koncového bodu řídí dávkování.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-116">The <xref:System.ServiceModel.Description.TransactedBatchingBehavior> endpoint behavior controls batching.</span></span> <span data-ttu-id="9f4f3-117">Přidání tohoto chování koncového bodu do koncového bodu služby říká Windows Communication Foundation (WCF) dávkové zprávy v transakci.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-117">Adding this endpoint behavior to a service endpoint tells Windows Communication Foundation (WCF) to batch messages in a transaction.</span></span> <span data-ttu-id="9f4f3-118">Ne všechny zprávy vyžadují transakci, takže pouze zprávy, které vyžadují transakci jsou umístěny `TransactionScopeRequired`  =  `true` `TransactionAutoComplete`  =  v dávce a pouze zprávy odeslané z operací označených a `true` jsou považovány za dávky.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-118">Not all messages require a transaction, so only messages that require a transaction are placed in a batch, and only messages sent from operations marked with `TransactionScopeRequired` = `true` and `TransactionAutoComplete` = `true` are considered for a batch.</span></span> <span data-ttu-id="9f4f3-119">Pokud jsou všechny operace na `TransactionScopeRequired`  =  `false` servisní `TransactionAutoComplete`  =  `false`smlouvě označeny a , režim dávkování není nikdy zadán.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-119">If all operations on the service contract are marked with `TransactionScopeRequired` = `false` and `TransactionAutoComplete` = `false`, then batching mode is never entered.</span></span>  
  
## <a name="committing-a-transaction"></a><span data-ttu-id="9f4f3-120">Potvrzení transakce</span><span class="sxs-lookup"><span data-stu-id="9f4f3-120">Committing a Transaction</span></span>  
 <span data-ttu-id="9f4f3-121">Dávková transakce je potvrzena na základě následujících:</span><span class="sxs-lookup"><span data-stu-id="9f4f3-121">A batched transaction is committed based on the following:</span></span>  
  
- <span data-ttu-id="9f4f3-122">`MaxBatchSize`.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-122">`MaxBatchSize`.</span></span> <span data-ttu-id="9f4f3-123">Vlastnost <xref:System.ServiceModel.Description.TransactedBatchingBehavior> chování.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-123">A property of the <xref:System.ServiceModel.Description.TransactedBatchingBehavior> behavior.</span></span> <span data-ttu-id="9f4f3-124">Tato vlastnost určuje maximální počet zpráv, které jsou umístěny do dávky.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-124">This property determines the maximum number of messages that are placed into a batch.</span></span> <span data-ttu-id="9f4f3-125">Po dosažení tohoto čísla je dávka potvrzena.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-125">When this number is reached, the batch is committed.</span></span> <span data-ttu-id="9f4f3-126">Tato hodnota není přísnýlimit, je možné potvrdit dávku před přijetím tohoto počtu zpráv.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-126">This is value is not a strict limit, it is possible to commit a batch before receiving this number of messages.</span></span>  
  
- <span data-ttu-id="9f4f3-127">`Transaction Timeout`.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-127">`Transaction Timeout`.</span></span> <span data-ttu-id="9f4f3-128">Po uplynutí 80 procent časového limitu transakce je dávka potvrzena a je vytvořena nová dávka.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-128">After 80 percent of the transaction's time-out has elapsed, the batch is committed and a new batch is created.</span></span> <span data-ttu-id="9f4f3-129">To znamená, že pokud 20 procent nebo méně času přiděleného pro transakci k dokončení zůstane, dávka je potvrzena.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-129">This means that if 20 percent or less of the time given for a transaction to complete remains, the batch is committed.</span></span>  
  
- <span data-ttu-id="9f4f3-130">`TransactionScopeRequired`.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-130">`TransactionScopeRequired`.</span></span> <span data-ttu-id="9f4f3-131">Při zpracování dávky zpráv, pokud WCF `TransactionScopeRequired`  =  `false`najde ten, který má , potvrdí dávku a `TransactionScopeRequired`  =  `true` znovu `TransactionAutoComplete`  = otevře novou dávku při přijetí první zprávy s a `true`.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-131">When processing a batch of messages, if WCF finds one that has `TransactionScopeRequired` = `false`, it commits the batch and reopens a new batch on receipt of the first message with `TransactionScopeRequired` = `true` and `TransactionAutoComplete` = `true`.</span></span>  
  
- <span data-ttu-id="9f4f3-132">Pokud ve frontě neexistují žádné další zprávy, je aktuální `MaxBatchSize` dávka potvrzena, i když nebylo dosaženo nebo neuplynulo 80 procent časového limitu transakce.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-132">If no more messages exist in the queue, then the current batch is committed, even if the `MaxBatchSize` has not been reached or 80 percent of the transaction's time-out has not elapsed.</span></span>  
  
## <a name="leaving-batching-mode"></a><span data-ttu-id="9f4f3-133">Opuštění režimu dávkování</span><span class="sxs-lookup"><span data-stu-id="9f4f3-133">Leaving Batching Mode</span></span>  
 <span data-ttu-id="9f4f3-134">Pokud zpráva v dávce způsobí přerušení transakce, dojde k následujícím krokům:</span><span class="sxs-lookup"><span data-stu-id="9f4f3-134">If a message in a batch causes the transaction to abort, the following steps occur:</span></span>  
  
1. <span data-ttu-id="9f4f3-135">Celá dávka zpráv je vrácena zpět.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-135">The entire batch of messages is rolled back.</span></span>  
  
2. <span data-ttu-id="9f4f3-136">Zprávy jsou čteny jeden po druhém, dokud počet přečtených zpráv překročí dvojnásobek maximální velikosti dávky.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-136">Messages are read one at a time until the number of messages read exceeds twice the maximum batch size.</span></span>  
  
3. <span data-ttu-id="9f4f3-137">Dávkový režim je znovu zadán.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-137">Batch mode is re-entered.</span></span>  
  
## <a name="choosing-the-batch-size"></a><span data-ttu-id="9f4f3-138">Výběr velikosti dávky</span><span class="sxs-lookup"><span data-stu-id="9f4f3-138">Choosing the Batch Size</span></span>  
 <span data-ttu-id="9f4f3-139">Velikost dávky je závislá na aplikaci.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-139">The size of a batch is application-dependent.</span></span> <span data-ttu-id="9f4f3-140">Empirická metoda je nejlepší způsob, jak dosáhnout optimální velikosti dávky pro aplikaci.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-140">The empirical method is the best way to arrive at an optimal batch size for the application.</span></span> <span data-ttu-id="9f4f3-141">Je důležité mít na paměti při výběru velikosti dávky zvolit velikost podle skutečného modelu nasazení vaší aplikace.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-141">It is important to remember when choosing a batch size to choose the size according to your application's actual deployment model.</span></span> <span data-ttu-id="9f4f3-142">Například při nasazování aplikace, pokud potřebujete sql server na vzdáleném počítači a transakce, která zahrnuje fronty a SQL server, pak velikost dávky je nejlépe určit spuštěním této přesné konfigurace.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-142">For example, when deploying the application, if you need an SQL server on a remote machine and a transaction that spans the queue and the SQL server, then the batch size is best determined by running this exact configuration.</span></span>  
  
## <a name="concurrency-and-batching"></a><span data-ttu-id="9f4f3-143">Souběžnost a dávkování</span><span class="sxs-lookup"><span data-stu-id="9f4f3-143">Concurrency and Batching</span></span>  
 <span data-ttu-id="9f4f3-144">Chcete-li zvýšit propustnost, můžete také mít mnoho dávek spustit současně.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-144">To increase throughput, you can also have many batches run concurrently.</span></span> <span data-ttu-id="9f4f3-145">Nastavením `ConcurrencyMode.Multiple` `ServiceBehaviorAttribute`v , můžete povolit souběžné dávkování.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-145">By setting `ConcurrencyMode.Multiple` in `ServiceBehaviorAttribute`, you enable concurrent batching.</span></span>  
  
 <span data-ttu-id="9f4f3-146">*Omezení služby* je chování služby, které se používá k označení, kolik maximální souběžná volání lze provést ve službě.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-146">*Service throttling* is a service behavior that is used to indicate how many maximum concurrent calls can be made on the service.</span></span> <span data-ttu-id="9f4f3-147">Při použití s dávkování, to je interpretovánjako kolik souběžných dávek lze spustit.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-147">When used with batching, this is interpreted as how many concurrent batches can be run.</span></span> <span data-ttu-id="9f4f3-148">Pokud omezení služby není nastavena, WCF výchozí maximální souběžná volání 16.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-148">If the service throttling is not set, WCF defaults the maximum concurrent calls to 16.</span></span> <span data-ttu-id="9f4f3-149">Proto pokud dávkování chování byly přidány ve výchozím nastavení, maximálně 16 dávek může být aktivní ve stejnou dobu.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-149">Thus, if batching behavior were added by default, a maximum of 16 batches can be active at the same time.</span></span> <span data-ttu-id="9f4f3-150">Nejlepší je vyladit omezení služby a dávkování na základě vaší kapacity.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-150">It is best to tune the service throttling and batching based on your capacity.</span></span> <span data-ttu-id="9f4f3-151">Například pokud fronta má 100 zpráv a dávka 20 je žádoucí, s maximální souběžná volání nastavena na 16 není užitečné, protože v závislosti na propustnost 16 transakcí může být aktivní, podobně jako s dávkování zapnuta.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-151">For example, if the queue has 100 messages and a batch of 20 is desired, having the maximum concurrent calls set to 16 is not useful because, depending on throughput, 16 transactions could be active, similar to not having batching turned on.</span></span> <span data-ttu-id="9f4f3-152">Proto při jemné množení pro výkon, buď nemají souběžné dávkování nebo mají souběžné dávkování se správnou velikostí omezení služby.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-152">Therefore, when fine-tuning for performance, either do not have concurrent batching or have concurrent batching with the correct service throttle size.</span></span>  
  
## <a name="batching-and-multiple-endpoints"></a><span data-ttu-id="9f4f3-153">Dávkování a více koncových bodů</span><span class="sxs-lookup"><span data-stu-id="9f4f3-153">Batching and Multiple Endpoints</span></span>  
 <span data-ttu-id="9f4f3-154">Koncový bod se skládá z adresy a smlouvy.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-154">An endpoint is composed of an address and a contract.</span></span> <span data-ttu-id="9f4f3-155">Může existovat více koncových bodů, které sdílejí stejnou vazbu.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-155">There may be multiple endpoints that share the same binding.</span></span> <span data-ttu-id="9f4f3-156">Je možné pro dva koncové body sdílet stejnou vazbu a poslouchat identifikátor jednotného prostředku (URI) nebo adresu fronty.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-156">It is possible for two endpoints to share the same binding and listen Uniform Resource Identifier (URI), or queue address.</span></span> <span data-ttu-id="9f4f3-157">Pokud dva koncové body jsou čtení ze stejné fronty a transakční dávkování chování je přidán do obou koncových bodů, může dojít ke konfliktu v velikosti dávky zadané.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-157">If two endpoints are reading from the same queue, and transacted batching behavior is added to both endpoints, a conflict in the batch sizes specified could arise.</span></span> <span data-ttu-id="9f4f3-158">To je vyřešeno implementací dávkování pomocí minimální velikosti dávky zadané mezi dvěma transakčními chováními dávkování.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-158">This is resolved by implementing batching using the minimal batch size specified between the two transacted batching behaviors.</span></span> <span data-ttu-id="9f4f3-159">V tomto scénáři pokud jeden z koncových bodů neurčuje transakční dávkování, pak by oba koncové body nepoužívaly dávkování.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-159">In this scenario, if one of the endpoints does not specify transacted batching, then both endpoints would not use batching.</span></span>  
  
## <a name="example"></a><span data-ttu-id="9f4f3-160">Příklad</span><span class="sxs-lookup"><span data-stu-id="9f4f3-160">Example</span></span>  
 <span data-ttu-id="9f4f3-161">Následující příklad ukazuje, jak `TransactedBatchingBehavior` zadat v konfiguračním souboru.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-161">The following example shows how to specify the `TransactedBatchingBehavior` in a configuration file.</span></span>  
  
```xml  
<behaviors>
  <endpointBehaviors>
    <behavior name="TransactedBatchingBehavior"
              maxBatchSize="100" />
  </endpointBehaviors>
</behaviors>
```  
  
 <span data-ttu-id="9f4f3-162">Následující příklad ukazuje, jak <xref:System.ServiceModel.Description.TransactedBatchingBehavior> zadat v kódu.</span><span class="sxs-lookup"><span data-stu-id="9f4f3-162">The following example shows how to specify the <xref:System.ServiceModel.Description.TransactedBatchingBehavior> in code.</span></span>  
  
```csharp
using (ServiceHost serviceHost = new ServiceHost(typeof(OrderProcessorService)))
{
     ServiceEndpoint sep = ServiceHost.AddServiceEndpoint(typeof(IOrderProcessor), new NetMsmqBinding(), "net.msmq://localhost/private/ServiceModelSamplesTransacted");
     sep.Behaviors.Add(new TransactedBatchingBehavior(100));

     // Open the ServiceHost to create listeners and start listening for messages.
    serviceHost.Open();
  
    // The service can now be accessed.
    Console.WriteLine("The service is ready.");
    Console.WriteLine("Press <ENTER> to terminate service.");
    Console.WriteLine();
    Console.ReadLine();
  
    // Close the ServiceHostB to shut down the service.
    serviceHost.Close();
}  
```  
  
## <a name="see-also"></a><span data-ttu-id="9f4f3-163">Viz také</span><span class="sxs-lookup"><span data-stu-id="9f4f3-163">See also</span></span>

- [<span data-ttu-id="9f4f3-164">Přehled front</span><span class="sxs-lookup"><span data-stu-id="9f4f3-164">Queues Overview</span></span>](../../../../docs/framework/wcf/feature-details/queues-overview.md)
- [<span data-ttu-id="9f4f3-165">Fronty ve WCF</span><span class="sxs-lookup"><span data-stu-id="9f4f3-165">Queuing in WCF</span></span>](../../../../docs/framework/wcf/feature-details/queuing-in-wcf.md)
