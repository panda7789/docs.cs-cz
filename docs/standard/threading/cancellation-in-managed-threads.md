---
title: Zrušení ve spravovaných vláknech
description: Pochopení zrušení ve spravovaných vláknech Přečtěte si o tokenech zrušení při kooperativním rušení asynchronních nebo dlouhodobě spuštěných synchronních operací.
ms.date: 03/30/2017
ms.technology: dotnet-standard
dev_langs:
- csharp
- vb
helpviewer_keywords:
- cancellation in .NET, overview
ms.assetid: eea11fe5-d8b0-4314-bb5d-8a58166fb1c3
ms.openlocfilehash: 9af4a64e50eff65023d5ed5bda868af2f8323a96
ms.sourcegitcommit: 7137e12f54c4e83a94ae43ec320f8cf59c1772ea
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 06/10/2020
ms.locfileid: "84662833"
---
# <a name="cancellation-in-managed-threads"></a><span data-ttu-id="862cb-104">Zrušení ve spravovaných vláknech</span><span class="sxs-lookup"><span data-stu-id="862cb-104">Cancellation in Managed Threads</span></span>
<span data-ttu-id="862cb-105">Počínaje .NET Framework 4 používá .NET Framework jednotný model pro spolupráci se zrušením asynchronních nebo dlouhodobě spuštěných synchronních operací.</span><span class="sxs-lookup"><span data-stu-id="862cb-105">Starting with the .NET Framework 4, the .NET Framework uses a unified model for cooperative cancellation of asynchronous or long-running synchronous operations.</span></span> <span data-ttu-id="862cb-106">Tento model je založen na odlehčeném objektu nazývaném token zrušení.</span><span class="sxs-lookup"><span data-stu-id="862cb-106">This model is based on a lightweight object called a cancellation token.</span></span> <span data-ttu-id="862cb-107">Objekt, který vyvolá jednu nebo více operací, které lze zrušit, například vytvořením nových vláken nebo úkolů, předá token každé operaci.</span><span class="sxs-lookup"><span data-stu-id="862cb-107">The object that invokes one or more cancelable operations, for example by creating new threads or tasks, passes the token to each operation.</span></span> <span data-ttu-id="862cb-108">Jednotlivé operace mohou v nástroji předat kopie tokenu jiným operacím.</span><span class="sxs-lookup"><span data-stu-id="862cb-108">Individual operations can in turn pass copies of the token to other operations.</span></span> <span data-ttu-id="862cb-109">V některých případech může objekt, který vytvořil token, použít ho k vyžádání, že operace přestanou dělat, co dělají.</span><span class="sxs-lookup"><span data-stu-id="862cb-109">At some later time, the object that created the token can use it to request that the operations stop what they are doing.</span></span> <span data-ttu-id="862cb-110">Pouze žádající objekt může vystavit žádost o zrušení a každý naslouchací proces zodpovídá za všímáteí žádosti a na ni včas reagovat.</span><span class="sxs-lookup"><span data-stu-id="862cb-110">Only the requesting object can issue the cancellation request, and each listener is responsible for noticing the request and responding to it in an appropriate and timely manner.</span></span>  
  
 <span data-ttu-id="862cb-111">Obecný vzor pro implementaci modelu zrušení spolupráce je:</span><span class="sxs-lookup"><span data-stu-id="862cb-111">The general pattern for implementing the cooperative cancellation model is:</span></span>  
  
- <span data-ttu-id="862cb-112">Vytvořte instanci <xref:System.Threading.CancellationTokenSource> objektu, který spravuje a odesílá oznámení o zrušení na jednotlivé tokeny zrušení.</span><span class="sxs-lookup"><span data-stu-id="862cb-112">Instantiate a <xref:System.Threading.CancellationTokenSource> object, which manages and sends cancellation notification to the individual cancellation tokens.</span></span>  
  
- <span data-ttu-id="862cb-113">Předání tokenu vráceného <xref:System.Threading.CancellationTokenSource.Token%2A?displayProperty=nameWithType> vlastností každému úkolu nebo vláknu, který naslouchá ke zrušení.</span><span class="sxs-lookup"><span data-stu-id="862cb-113">Pass the token returned by the <xref:System.Threading.CancellationTokenSource.Token%2A?displayProperty=nameWithType> property to each task or thread that listens for cancellation.</span></span>  
  
- <span data-ttu-id="862cb-114">Poskytněte mechanismus pro každý úkol nebo vlákno, které budou reagovat na zrušení.</span><span class="sxs-lookup"><span data-stu-id="862cb-114">Provide a mechanism for each task or thread to respond to cancellation.</span></span>  
  
- <span data-ttu-id="862cb-115">Zavolejte <xref:System.Threading.CancellationTokenSource.Cancel%2A?displayProperty=nameWithType> metodu pro poskytnutí oznámení o zrušení.</span><span class="sxs-lookup"><span data-stu-id="862cb-115">Call the <xref:System.Threading.CancellationTokenSource.Cancel%2A?displayProperty=nameWithType> method to provide notification of cancellation.</span></span>  
  
> [!IMPORTANT]
> <span data-ttu-id="862cb-116">Třída <xref:System.Threading.CancellationTokenSource> implementuje rozhraní <xref:System.IDisposable>.</span><span class="sxs-lookup"><span data-stu-id="862cb-116">The <xref:System.Threading.CancellationTokenSource> class implements the <xref:System.IDisposable> interface.</span></span> <span data-ttu-id="862cb-117">Měli byste být schopni zavolat <xref:System.Threading.CancellationTokenSource.Dispose%2A?displayProperty=nameWithType> metodu po dokončení použití zdroje tokenu zrušení pro uvolnění jakýchkoli nespravovaných prostředků, které obsahuje.</span><span class="sxs-lookup"><span data-stu-id="862cb-117">You should be sure to call the <xref:System.Threading.CancellationTokenSource.Dispose%2A?displayProperty=nameWithType> method when you have finished using the cancellation token source to free any unmanaged resources it holds.</span></span>  
  
 <span data-ttu-id="862cb-118">Následující ilustrace znázorňuje vztah mezi zdrojem tokenu a všemi kopiemi jeho tokenu.</span><span class="sxs-lookup"><span data-stu-id="862cb-118">The following illustration shows the relationship between a token source and all the copies of its token.</span></span>  
  
 <span data-ttu-id="862cb-119">![CancellationTokenSource a zrušení tokenů](media/vs-cancellationtoken.png "VS_CancellationToken")</span><span class="sxs-lookup"><span data-stu-id="862cb-119">![CancellationTokenSource and cancellation tokens](media/vs-cancellationtoken.png "VS_CancellationToken")</span></span>  
  
 <span data-ttu-id="862cb-120">Nový model zrušení usnadňuje vytváření aplikací a knihoven s podporou zrušení a podporuje následující funkce:</span><span class="sxs-lookup"><span data-stu-id="862cb-120">The new cancellation model makes it easier to create cancellation-aware applications and libraries, and it supports the following features:</span></span>  
  
- <span data-ttu-id="862cb-121">Zrušení je kooperativní a není vynuceno na naslouchací službě.</span><span class="sxs-lookup"><span data-stu-id="862cb-121">Cancellation is cooperative and is not forced on the listener.</span></span> <span data-ttu-id="862cb-122">Naslouchací proces určuje, jak se má řádně ukončit reakce na žádost o zrušení.</span><span class="sxs-lookup"><span data-stu-id="862cb-122">The listener determines how to gracefully terminate in response to a cancellation request.</span></span>  
  
- <span data-ttu-id="862cb-123">Požadavek se liší od naslouchání.</span><span class="sxs-lookup"><span data-stu-id="862cb-123">Requesting is distinct from listening.</span></span> <span data-ttu-id="862cb-124">Objekt, který vyvolá operaci s možnou metodou zrušení, může řídit, kdy se požaduje zrušení zrušení.</span><span class="sxs-lookup"><span data-stu-id="862cb-124">An object that invokes a cancelable operation can control when (if ever) cancellation is requested.</span></span>  
  
- <span data-ttu-id="862cb-125">Žádající objekt vydá žádost o zrušení všem kopiím tokenu pomocí volání pouze jednoho volání metody.</span><span class="sxs-lookup"><span data-stu-id="862cb-125">The requesting object issues the cancellation request to all copies of the token by using just one method call.</span></span>  
  
- <span data-ttu-id="862cb-126">Naslouchací proces může naslouchat více tokeny současně jejich připojením k jednomu *odkazovanému tokenu*.</span><span class="sxs-lookup"><span data-stu-id="862cb-126">A listener can listen to multiple tokens simultaneously by joining them into one *linked token*.</span></span>  
  
- <span data-ttu-id="862cb-127">Uživatelský kód může všimnout a reagovat na žádosti o zrušení z kódu knihovny a kód knihovny může všimnout a reagovat na žádosti o zrušení z uživatelského kódu.</span><span class="sxs-lookup"><span data-stu-id="862cb-127">User code can notice and respond to cancellation requests from library code, and library code can notice and respond to cancellation requests from user code.</span></span>  
  
- <span data-ttu-id="862cb-128">Naslouchací procesy mohou být upozorňovány na žádosti o zrušení pomocí cyklického dotazování, registrace zpětného volání nebo čekání na obslužné rutiny čekání.</span><span class="sxs-lookup"><span data-stu-id="862cb-128">Listeners can be notified of cancellation requests by polling, callback registration, or waiting on wait handles.</span></span>  
  
## <a name="cancellation-types"></a><span data-ttu-id="862cb-129">Typy zrušení</span><span class="sxs-lookup"><span data-stu-id="862cb-129">Cancellation Types</span></span>  
 <span data-ttu-id="862cb-130">Rozhraní zrušení je implementováno jako sada souvisejících typů, které jsou uvedeny v následující tabulce.</span><span class="sxs-lookup"><span data-stu-id="862cb-130">The cancellation framework is implemented as a set of related types, which are listed in the following table.</span></span>  
  
|<span data-ttu-id="862cb-131">Název typu</span><span class="sxs-lookup"><span data-stu-id="862cb-131">Type name</span></span>|<span data-ttu-id="862cb-132">Popis</span><span class="sxs-lookup"><span data-stu-id="862cb-132">Description</span></span>|  
|---------------|-----------------|  
|<xref:System.Threading.CancellationTokenSource>|<span data-ttu-id="862cb-133">Objekt, který vytvoří token zrušení, a také vydá požadavek na zrušení pro všechny kopie tohoto tokenu.</span><span class="sxs-lookup"><span data-stu-id="862cb-133">Object that creates a cancellation token, and also issues the cancellation request for all copies of that token.</span></span>|  
|<xref:System.Threading.CancellationToken>|<span data-ttu-id="862cb-134">Nenáročný typ hodnoty předaný jednomu nebo více posluchačům, obvykle jako parametr metody.</span><span class="sxs-lookup"><span data-stu-id="862cb-134">Lightweight value type passed to one or more listeners, typically as a method parameter.</span></span> <span data-ttu-id="862cb-135">Naslouchací procesy monitorují hodnotu `IsCancellationRequested` vlastnosti tokenu pomocí cyklického dotazování, zpětného volání nebo popisovače čekání.</span><span class="sxs-lookup"><span data-stu-id="862cb-135">Listeners monitor the value of the `IsCancellationRequested` property of the token by polling, callback, or wait handle.</span></span>|  
|<xref:System.OperationCanceledException>|<span data-ttu-id="862cb-136">Přetížení konstruktoru této výjimky přijímají <xref:System.Threading.CancellationToken> jako parametr.</span><span class="sxs-lookup"><span data-stu-id="862cb-136">Overloads of this exception's constructor accept a <xref:System.Threading.CancellationToken> as a parameter.</span></span> <span data-ttu-id="862cb-137">Naslouchací procesy mohou volitelně vyvolat tuto výjimku za účelem ověření zdroje zrušení a informování dalších uživatelů, že odpověděli na žádost o zrušení.</span><span class="sxs-lookup"><span data-stu-id="862cb-137">Listeners can optionally throw this exception to verify the source of the cancellation and notify others that it has responded to a cancellation request.</span></span>|  
  
 <span data-ttu-id="862cb-138">Nový model zrušení je integrován do .NET Framework v několika typech.</span><span class="sxs-lookup"><span data-stu-id="862cb-138">The new cancellation model is integrated into the .NET Framework in several types.</span></span> <span data-ttu-id="862cb-139">Nejdůležitějšími těmi jsou <xref:System.Threading.Tasks.Parallel?displayProperty=nameWithType> , <xref:System.Threading.Tasks.Task?displayProperty=nameWithType> <xref:System.Threading.Tasks.Task%601?displayProperty=nameWithType> a <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType> .</span><span class="sxs-lookup"><span data-stu-id="862cb-139">The most important ones are <xref:System.Threading.Tasks.Parallel?displayProperty=nameWithType>, <xref:System.Threading.Tasks.Task?displayProperty=nameWithType>, <xref:System.Threading.Tasks.Task%601?displayProperty=nameWithType> and <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType>.</span></span> <span data-ttu-id="862cb-140">Pro všechny nové knihovny a kód aplikace doporučujeme použít tento nový model zrušení.</span><span class="sxs-lookup"><span data-stu-id="862cb-140">We recommend that you use this new cancellation model for all new library and application code.</span></span>  
  
## <a name="code-example"></a><span data-ttu-id="862cb-141">Příklad kódu</span><span class="sxs-lookup"><span data-stu-id="862cb-141">Code Example</span></span>  
 <span data-ttu-id="862cb-142">V následujícím příkladu žádající objekt vytvoří <xref:System.Threading.CancellationTokenSource> objekt a poté předá jeho <xref:System.Threading.CancellationTokenSource.Token%2A> vlastnost operaci, kterou lze zrušit.</span><span class="sxs-lookup"><span data-stu-id="862cb-142">In the following example, the requesting object creates a <xref:System.Threading.CancellationTokenSource> object, and then passes its <xref:System.Threading.CancellationTokenSource.Token%2A> property to the cancelable operation.</span></span> <span data-ttu-id="862cb-143">Operace, která přijme požadavek, monitoruje hodnotu <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> vlastnosti tokenu pomocí cyklického dotazování.</span><span class="sxs-lookup"><span data-stu-id="862cb-143">The operation that receives the request monitors the value of the <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> property of the token by polling.</span></span> <span data-ttu-id="862cb-144">Když se hodnota přestanou `true` , naslouchací proces může skončit jakýmkoli způsobem.</span><span class="sxs-lookup"><span data-stu-id="862cb-144">When the value becomes `true`, the listener can terminate in whatever manner is appropriate.</span></span> <span data-ttu-id="862cb-145">V tomto příkladu metoda pouze ukončí, což je vše vyžadované v mnoha případech.</span><span class="sxs-lookup"><span data-stu-id="862cb-145">In this example, the method just exits, which is all that is required in many cases.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="862cb-146">V příkladu se používá <xref:System.Threading.ThreadPool.QueueUserWorkItem%2A> Metoda k předvedení, že nové rozhraní zrušení je kompatibilní se staršími rozhraními API.</span><span class="sxs-lookup"><span data-stu-id="862cb-146">The example uses the <xref:System.Threading.ThreadPool.QueueUserWorkItem%2A> method to demonstrate that the new cancellation framework is compatible with legacy APIs.</span></span> <span data-ttu-id="862cb-147">Příklad, který používá nový preferovaný <xref:System.Threading.Tasks.Task?displayProperty=nameWithType> typ, naleznete v tématu [How to: Cancel a a jejích podřízených objektů](../parallel-programming/how-to-cancel-a-task-and-its-children.md).</span><span class="sxs-lookup"><span data-stu-id="862cb-147">For an example that uses the new, preferred <xref:System.Threading.Tasks.Task?displayProperty=nameWithType> type, see [How to: Cancel a Task and Its Children](../parallel-programming/how-to-cancel-a-task-and-its-children.md).</span></span>  
  
 [!code-csharp[Cancellation#1](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex1.cs#1)]
 [!code-vb[Cancellation#1](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex1.vb#1)]  
  
## <a name="operation-cancellation-versus-object-cancellation"></a><span data-ttu-id="862cb-148">Zrušení operace versus zrušení objektu</span><span class="sxs-lookup"><span data-stu-id="862cb-148">Operation Cancellation Versus Object Cancellation</span></span>  
 <span data-ttu-id="862cb-149">V novém rozhraní zrušení odkazuje zrušení na operace, nikoli na objekty.</span><span class="sxs-lookup"><span data-stu-id="862cb-149">In the new cancellation framework, cancellation refers to operations, not objects.</span></span> <span data-ttu-id="862cb-150">Žádost o zrušení znamená, že operace by se měla zastavit co nejdříve po provedení veškerého potřebného vyčištění.</span><span class="sxs-lookup"><span data-stu-id="862cb-150">The cancellation request means that the operation should stop as soon as possible after any required cleanup is performed.</span></span> <span data-ttu-id="862cb-151">Jeden token zrušení by měl odkazovat na jednu operaci, kterou lze zrušit, tato operace však může být implementována v programu.</span><span class="sxs-lookup"><span data-stu-id="862cb-151">One cancellation token should refer to one "cancelable operation," however that operation may be implemented in your program.</span></span> <span data-ttu-id="862cb-152">Po <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> nastavení vlastnosti tokenu na hodnotu `true` nemůže být obnovena `false` .</span><span class="sxs-lookup"><span data-stu-id="862cb-152">After the <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> property of the token has been set to `true`, it cannot be reset to `false`.</span></span> <span data-ttu-id="862cb-153">Proto se tokeny zrušení po zrušení nedají znovu použít.</span><span class="sxs-lookup"><span data-stu-id="862cb-153">Therefore, cancellation tokens cannot be reused after they have been canceled.</span></span>  
  
 <span data-ttu-id="862cb-154">Pokud vyžadujete mechanismus zrušení objektu, můžete ho založit na mechanismu zrušení operace voláním <xref:System.Threading.CancellationToken.Register%2A?displayProperty=nameWithType> metody, jak je znázorněno v následujícím příkladu.</span><span class="sxs-lookup"><span data-stu-id="862cb-154">If you require an object cancellation mechanism, you can base it on the operation cancellation mechanism by calling the <xref:System.Threading.CancellationToken.Register%2A?displayProperty=nameWithType> method, as shown in the following example.</span></span>  
  
 [!code-csharp[Cancellation#2](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/objectcancellation1.cs#2)]
 [!code-vb[Cancellation#2](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/objectcancellation1.vb#2)]  
  
 <span data-ttu-id="862cb-155">Pokud objekt podporuje více než jednu souběžnou operaci, která může být zrušena, předejte samostatný token jako vstup do každé samostatné operace zrušení.</span><span class="sxs-lookup"><span data-stu-id="862cb-155">If an object supports more than one concurrent cancelable operation, pass a separate token as input to each distinct cancelable operation.</span></span> <span data-ttu-id="862cb-156">Tímto způsobem je možné zrušit jednu operaci, aniž by to ovlivnilo ostatní.</span><span class="sxs-lookup"><span data-stu-id="862cb-156">That way, one operation can be cancelled without affecting the others.</span></span>  
  
## <a name="listening-and-responding-to-cancellation-requests"></a><span data-ttu-id="862cb-157">Naslouchat a reagovat na žádosti o zrušení</span><span class="sxs-lookup"><span data-stu-id="862cb-157">Listening and Responding to Cancellation Requests</span></span>  
 <span data-ttu-id="862cb-158">V uživatelském delegátu může implementátor operace s zrušením určit, jak ukončit operaci v reakci na žádost o zrušení.</span><span class="sxs-lookup"><span data-stu-id="862cb-158">In the user delegate, the implementer of a cancelable operation determines how to terminate the operation in response to a cancellation request.</span></span> <span data-ttu-id="862cb-159">V mnoha případech může delegát uživatele provést pouze požadované vyčištění a pak hned vrátit.</span><span class="sxs-lookup"><span data-stu-id="862cb-159">In many cases, the user delegate can just perform any required cleanup and then return immediately.</span></span>  
  
 <span data-ttu-id="862cb-160">Ve složitějších případech ale může být nutné, aby uživatel s delegátem upozornil na kód knihovny, ke kterému došlo ke zrušení.</span><span class="sxs-lookup"><span data-stu-id="862cb-160">However, in more complex cases, it might be necessary for the user delegate to notify library code that cancellation has occurred.</span></span> <span data-ttu-id="862cb-161">V takových případech je správný způsob, jak operaci ukončit, je pro delegáta volat <xref:System.Threading.CancellationToken.ThrowIfCancellationRequested%2A> metodu, která způsobí <xref:System.OperationCanceledException> vyvolání.</span><span class="sxs-lookup"><span data-stu-id="862cb-161">In such cases, the correct way to terminate the operation is for the delegate to call the <xref:System.Threading.CancellationToken.ThrowIfCancellationRequested%2A>, method, which will cause an <xref:System.OperationCanceledException> to be thrown.</span></span> <span data-ttu-id="862cb-162">Kód knihovny může zachytit tuto výjimku ve vlákně delegáta uživatele a ověřit token výjimky a zjistit, zda výjimka označuje kooperativní zrušení nebo jinou výjimečnou situaci.</span><span class="sxs-lookup"><span data-stu-id="862cb-162">Library code can catch this exception on the user delegate thread and examine the exception's token to determine whether the exception indicates cooperative cancellation or some other exceptional situation.</span></span>  
  
 <span data-ttu-id="862cb-163"><xref:System.Threading.Tasks.Task>Třída zpracovává <xref:System.OperationCanceledException> tímto způsobem.</span><span class="sxs-lookup"><span data-stu-id="862cb-163">The <xref:System.Threading.Tasks.Task> class handles <xref:System.OperationCanceledException> in this way.</span></span> <span data-ttu-id="862cb-164">Další informace najdete v tématu [zrušení úlohy](../parallel-programming/task-cancellation.md).</span><span class="sxs-lookup"><span data-stu-id="862cb-164">For more information, see [Task Cancellation](../parallel-programming/task-cancellation.md).</span></span>  
  
### <a name="listening-by-polling"></a><span data-ttu-id="862cb-165">Naslouchání pomocí cyklického dotazování</span><span class="sxs-lookup"><span data-stu-id="862cb-165">Listening by Polling</span></span>  
 <span data-ttu-id="862cb-166">U dlouhotrvajících výpočtů, které cyklují nebo rekurzování můžete poslouchat žádost o zrušení pravidelným dotazování hodnoty <xref:System.Threading.CancellationToken.IsCancellationRequested%2A?displayProperty=nameWithType> Vlastnosti.</span><span class="sxs-lookup"><span data-stu-id="862cb-166">For long-running computations that loop or recurse, you can listen for a cancellation request by periodically polling the value of the <xref:System.Threading.CancellationToken.IsCancellationRequested%2A?displayProperty=nameWithType> property.</span></span> <span data-ttu-id="862cb-167">Pokud je jeho hodnota `true` , metoda by měla co nejrychleji vyčistit a ukončit.</span><span class="sxs-lookup"><span data-stu-id="862cb-167">If its value is `true`, the method should clean up and terminate as quickly as possible.</span></span> <span data-ttu-id="862cb-168">Optimální frekvence cyklického dotazování závisí na typu aplikace.</span><span class="sxs-lookup"><span data-stu-id="862cb-168">The optimal frequency of polling depends on the type of application.</span></span> <span data-ttu-id="862cb-169">Aby bylo možné určit nejlepší četnost dotazování pro libovolný daný program, je to pro vývojáře.</span><span class="sxs-lookup"><span data-stu-id="862cb-169">It is up to the developer to determine the best polling frequency for any given program.</span></span> <span data-ttu-id="862cb-170">Cyklické dotazování sama o sobě nijak neovlivňuje výkon.</span><span class="sxs-lookup"><span data-stu-id="862cb-170">Polling itself does not significantly impact performance.</span></span> <span data-ttu-id="862cb-171">Následující příklad ukazuje jeden možný způsob dotazování.</span><span class="sxs-lookup"><span data-stu-id="862cb-171">The following example shows one possible way to poll.</span></span>  
  
 [!code-csharp[Cancellation#3](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex11.cs#3)]
 [!code-vb[Cancellation#3](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex11.vb#3)]  
  
 <span data-ttu-id="862cb-172">Úplnější příklad naleznete v tématu [How to: Listening for requests on a cyklické dotazování](how-to-listen-for-cancellation-requests-by-polling.md).</span><span class="sxs-lookup"><span data-stu-id="862cb-172">For a more complete example, see [How to: Listen for Cancellation Requests by Polling](how-to-listen-for-cancellation-requests-by-polling.md).</span></span>  
  
### <a name="listening-by-registering-a-callback"></a><span data-ttu-id="862cb-173">Naslouchání registrací zpětného volání</span><span class="sxs-lookup"><span data-stu-id="862cb-173">Listening by Registering a Callback</span></span>  
 <span data-ttu-id="862cb-174">Některé operace se mohou zablokovat takovým způsobem, že nemohou včas kontrolovat hodnotu tokenu zrušení.</span><span class="sxs-lookup"><span data-stu-id="862cb-174">Some operations can become blocked in such a way that they cannot check the value of the cancellation token in a timely manner.</span></span> <span data-ttu-id="862cb-175">V těchto případech můžete zaregistrovat metodu zpětného volání, která odblokuje metodu při přijetí žádosti o zrušení.</span><span class="sxs-lookup"><span data-stu-id="862cb-175">For these cases, you can register a callback method that unblocks the method when a cancellation request is received.</span></span>  
  
 <span data-ttu-id="862cb-176"><xref:System.Threading.CancellationToken.Register%2A>Metoda vrátí <xref:System.Threading.CancellationTokenRegistration> objekt, který se používá specificky pro tento účel.</span><span class="sxs-lookup"><span data-stu-id="862cb-176">The <xref:System.Threading.CancellationToken.Register%2A> method returns a <xref:System.Threading.CancellationTokenRegistration> object that is used specifically for this purpose.</span></span> <span data-ttu-id="862cb-177">Následující příklad ukazuje, jak použít <xref:System.Threading.CancellationToken.Register%2A> metodu pro zrušení asynchronního webového požadavku.</span><span class="sxs-lookup"><span data-stu-id="862cb-177">The following example shows how to use the <xref:System.Threading.CancellationToken.Register%2A> method to cancel an asynchronous Web request.</span></span>  
  
 [!code-csharp[Cancellation#4](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex4.cs#4)]
 [!code-vb[Cancellation#4](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex4.vb#4)]  
  
 <span data-ttu-id="862cb-178"><xref:System.Threading.CancellationTokenRegistration>Objekt spravuje synchronizaci vláken a zajišťuje, že zpětné volání přestane být spuštěno v přesném bodě v čase.</span><span class="sxs-lookup"><span data-stu-id="862cb-178">The <xref:System.Threading.CancellationTokenRegistration> object manages thread synchronization and ensures that the callback will stop executing at a precise point in time.</span></span>  
  
 <span data-ttu-id="862cb-179">Aby se zajistila odezva systému a aby se zabránilo zablokování, při registraci zpětných volání musí být dodrženy následující pokyny:</span><span class="sxs-lookup"><span data-stu-id="862cb-179">In order to ensure system responsiveness and to avoid deadlocks, the following guidelines must be followed when registering callbacks:</span></span>  
  
- <span data-ttu-id="862cb-180">Metoda zpětného volání by měla být rychlá, protože je volána synchronně, proto volání nevrátí, <xref:System.Threading.CancellationTokenSource.Cancel%2A> dokud zpětné volání nevrátí.</span><span class="sxs-lookup"><span data-stu-id="862cb-180">The callback method should be fast because it is called synchronously and therefore the call to <xref:System.Threading.CancellationTokenSource.Cancel%2A> does not return until the callback returns.</span></span>  
  
- <span data-ttu-id="862cb-181">Pokud zavoláte <xref:System.Threading.CancellationTokenRegistration.Dispose%2A> na běhu zpětného volání a podržíte zámek, na kterém zpětné volání čeká, váš program může zablokovat.</span><span class="sxs-lookup"><span data-stu-id="862cb-181">If you call <xref:System.Threading.CancellationTokenRegistration.Dispose%2A> while the callback is running, and you hold a lock that the callback is waiting on, your program can deadlock.</span></span> <span data-ttu-id="862cb-182">Po `Dispose` návratu můžete uvolnit všechny prostředky, které zpětné volání vyžaduje.</span><span class="sxs-lookup"><span data-stu-id="862cb-182">After `Dispose` returns, you can free any resources required by the callback.</span></span>  
  
- <span data-ttu-id="862cb-183">Zpětná volání by neměla provádět žádné ruční vlákno nebo <xref:System.Threading.SynchronizationContext> použití ve zpětném volání.</span><span class="sxs-lookup"><span data-stu-id="862cb-183">Callbacks should not perform any manual thread or <xref:System.Threading.SynchronizationContext> usage in a callback.</span></span> <span data-ttu-id="862cb-184">Pokud zpětné volání musí být spuštěno v konkrétním vlákně, použijte <xref:System.Threading.CancellationTokenRegistration?displayProperty=nameWithType> konstruktor, který umožňuje určit, že cílový syncContext je aktivní <xref:System.Threading.SynchronizationContext.Current%2A?displayProperty=nameWithType> .</span><span class="sxs-lookup"><span data-stu-id="862cb-184">If a callback must run on a particular thread, use the <xref:System.Threading.CancellationTokenRegistration?displayProperty=nameWithType> constructor that enables you to specify that the target syncContext is the active <xref:System.Threading.SynchronizationContext.Current%2A?displayProperty=nameWithType>.</span></span> <span data-ttu-id="862cb-185">Ruční provádění vláken ve zpětném volání může způsobit zablokování.</span><span class="sxs-lookup"><span data-stu-id="862cb-185">Performing manual threading in a callback can cause deadlock.</span></span>  
  
 <span data-ttu-id="862cb-186">Úplnější příklad naleznete v tématu [How to: Register Callbacks for requests](how-to-register-callbacks-for-cancellation-requests.md).</span><span class="sxs-lookup"><span data-stu-id="862cb-186">For a more complete example, see [How to: Register Callbacks for Cancellation Requests](how-to-register-callbacks-for-cancellation-requests.md).</span></span>  
  
### <a name="listening-by-using-a-wait-handle"></a><span data-ttu-id="862cb-187">Poslech pomocí popisovače čekání</span><span class="sxs-lookup"><span data-stu-id="862cb-187">Listening by Using a Wait Handle</span></span>  
 <span data-ttu-id="862cb-188">Když se může zrušit operace, která může být zablokovaná, zatímco čeká na primitivu synchronizace, jako je <xref:System.Threading.ManualResetEvent?displayProperty=nameWithType> nebo <xref:System.Threading.Semaphore?displayProperty=nameWithType> , můžete <xref:System.Threading.CancellationToken.WaitHandle%2A?displayProperty=nameWithType> vlastnost použít k povolení operace počkat na událost i na žádost o zrušení.</span><span class="sxs-lookup"><span data-stu-id="862cb-188">When a cancelable operation can block while it waits on a synchronization primitive such as a <xref:System.Threading.ManualResetEvent?displayProperty=nameWithType> or <xref:System.Threading.Semaphore?displayProperty=nameWithType>, you can use the <xref:System.Threading.CancellationToken.WaitHandle%2A?displayProperty=nameWithType> property to enable the operation to wait on both the event and the cancellation request.</span></span> <span data-ttu-id="862cb-189">Obslužná rutina čekání na token zrušení se bude signalizovat jako odpověď na žádost o zrušení a metoda může použít návratovou hodnotu <xref:System.Threading.WaitHandle.WaitAny%2A> metody k určení, zda se jednalo o token zrušení, který signalizace.</span><span class="sxs-lookup"><span data-stu-id="862cb-189">The wait handle of the cancellation token will become signaled in response to a cancellation request, and the method can use the return value of the <xref:System.Threading.WaitHandle.WaitAny%2A> method to determine whether it was the cancellation token that signaled.</span></span> <span data-ttu-id="862cb-190">Operace pak může pouze skončit nebo vyvolat <xref:System.OperationCanceledException> , podle potřeby.</span><span class="sxs-lookup"><span data-stu-id="862cb-190">The operation can then just exit, or throw a <xref:System.OperationCanceledException>, as appropriate.</span></span>  
  
 [!code-csharp[Cancellation#5](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex9.cs#5)]
 [!code-vb[Cancellation#5](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex9.vb#5)]  
  
 <span data-ttu-id="862cb-191">V novém kódu, který cílí na .NET Framework 4, <xref:System.Threading.ManualResetEventSlim?displayProperty=nameWithType> a <xref:System.Threading.SemaphoreSlim?displayProperty=nameWithType> obě podporují nové rozhraní zrušení v jejich `Wait` metodách.</span><span class="sxs-lookup"><span data-stu-id="862cb-191">In new code that targets the .NET Framework 4, <xref:System.Threading.ManualResetEventSlim?displayProperty=nameWithType> and <xref:System.Threading.SemaphoreSlim?displayProperty=nameWithType> both support the new cancellation framework in their `Wait` methods.</span></span> <span data-ttu-id="862cb-192">Můžete předat <xref:System.Threading.CancellationToken> metodě a když je požadováno zrušení, událost se probudí a vyvolá <xref:System.OperationCanceledException> .</span><span class="sxs-lookup"><span data-stu-id="862cb-192">You can pass the <xref:System.Threading.CancellationToken> to the method, and when the cancellation is requested, the event wakes up and throws an <xref:System.OperationCanceledException>.</span></span>  
  
 [!code-csharp[Cancellation#6](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex10.cs#6)]
 [!code-vb[Cancellation#6](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex10.vb#6)]  
  
 <span data-ttu-id="862cb-193">Úplnější příklad naleznete v tématu [How to: Listen for zrušení žádosti, které mají obslužné rutiny čekání](how-to-listen-for-cancellation-requests-that-have-wait-handles.md).</span><span class="sxs-lookup"><span data-stu-id="862cb-193">For a more complete example, see [How to: Listen for Cancellation Requests That Have Wait Handles](how-to-listen-for-cancellation-requests-that-have-wait-handles.md).</span></span>  
  
### <a name="listening-to-multiple-tokens-simultaneously"></a><span data-ttu-id="862cb-194">Souběžné naslouchat více tokenům</span><span class="sxs-lookup"><span data-stu-id="862cb-194">Listening to Multiple Tokens Simultaneously</span></span>  
 <span data-ttu-id="862cb-195">V některých případech může naslouchací proces naslouchat více tokenům zrušení současně.</span><span class="sxs-lookup"><span data-stu-id="862cb-195">In some cases, a listener may have to listen to multiple cancellation tokens simultaneously.</span></span> <span data-ttu-id="862cb-196">Například operace s zrušením může být nutné monitorovat interní token zrušení kromě tokenu předaného externě jako argument parametru metody.</span><span class="sxs-lookup"><span data-stu-id="862cb-196">For example, a cancelable operation may have to monitor an internal cancellation token in addition to a token passed in externally as an argument to a method parameter.</span></span> <span data-ttu-id="862cb-197">Chcete-li to provést, vytvořte propojený zdroj tokenu, který může spojit dva nebo více tokenů do jednoho tokenu, jak je znázorněno v následujícím příkladu.</span><span class="sxs-lookup"><span data-stu-id="862cb-197">To accomplish this, create a linked token source that can join two or more tokens into one token, as shown in the following example.</span></span>  
  
 [!code-csharp[Cancellation#7](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex13.cs#7)]
 [!code-vb[Cancellation#7](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex13.vb#7)]  
  
 <span data-ttu-id="862cb-198">Všimněte si, že `Dispose` když s ním budete hotovi, musíte zavolat na propojený zdroj tokenu.</span><span class="sxs-lookup"><span data-stu-id="862cb-198">Notice that you must call `Dispose` on the linked token source when you are done with it.</span></span> <span data-ttu-id="862cb-199">Úplnější příklad naleznete v tématu [How to: Listen for Multiple requests](how-to-listen-for-multiple-cancellation-requests.md).</span><span class="sxs-lookup"><span data-stu-id="862cb-199">For a more complete example, see [How to: Listen for Multiple Cancellation Requests](how-to-listen-for-multiple-cancellation-requests.md).</span></span>  
  
## <a name="cooperation-between-library-code-and-user-code"></a><span data-ttu-id="862cb-200">Spolupráce mezi kódem knihovny a uživatelským kódem</span><span class="sxs-lookup"><span data-stu-id="862cb-200">Cooperation Between Library Code and User Code</span></span>  
 <span data-ttu-id="862cb-201">Jednotná architektura zrušení umožňuje kódu knihovny zrušit kód uživatele a kód pro zrušení kódu knihovny.</span><span class="sxs-lookup"><span data-stu-id="862cb-201">The unified cancellation framework makes it possible for library code to cancel user code, and for user code to cancel library code in a cooperative manner.</span></span> <span data-ttu-id="862cb-202">Bezproblémová spolupráce závisí na každé ze strany těchto pokynů:</span><span class="sxs-lookup"><span data-stu-id="862cb-202">Smooth cooperation depends on each side following these guidelines:</span></span>  
  
- <span data-ttu-id="862cb-203">Pokud kód knihovny poskytuje operace, které lze zrušit, měla by také poskytovat veřejné metody, které přijímají externí token zrušení, aby mohl kód uživatele požádat o zrušení.</span><span class="sxs-lookup"><span data-stu-id="862cb-203">If library code provides cancelable operations, it should also provide public methods that accept an external cancellation token so that user code can request cancellation.</span></span>  
  
- <span data-ttu-id="862cb-204">Pokud kód knihovny volá do uživatelského kódu, kód knihovny by měl interpretovat OperationCanceledException (externalToken) jako *kooperativní zrušení*a nemusí nutně znamenat výjimku selhání.</span><span class="sxs-lookup"><span data-stu-id="862cb-204">If library code calls into user code, the library code should interpret an OperationCanceledException(externalToken) as *cooperative cancellation*, and not necessarily as a failure exception.</span></span>  
  
- <span data-ttu-id="862cb-205">Delegáti uživatele by se měli snažit včas odpovědět na žádosti o zrušení z kódu knihovny.</span><span class="sxs-lookup"><span data-stu-id="862cb-205">User-delegates should attempt to respond to cancellation requests from library code in a timely manner.</span></span>  
  
 <span data-ttu-id="862cb-206"><xref:System.Threading.Tasks.Task?displayProperty=nameWithType>a <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType> jsou příklady tříd, které následují podle těchto pokynů.</span><span class="sxs-lookup"><span data-stu-id="862cb-206"><xref:System.Threading.Tasks.Task?displayProperty=nameWithType> and <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType> are examples of classes that follow these guidelines.</span></span> <span data-ttu-id="862cb-207">Další informace naleznete v tématu [zrušení úlohy](../parallel-programming/task-cancellation.md) a [Postup: zrušení dotazu PLINQ](../parallel-programming/how-to-cancel-a-plinq-query.md).</span><span class="sxs-lookup"><span data-stu-id="862cb-207">For more information, see [Task Cancellation](../parallel-programming/task-cancellation.md) and [How to: Cancel a PLINQ Query](../parallel-programming/how-to-cancel-a-plinq-query.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="862cb-208">Viz také</span><span class="sxs-lookup"><span data-stu-id="862cb-208">See also</span></span>

- [<span data-ttu-id="862cb-209">Základy dělení na spravovaná vlákna</span><span class="sxs-lookup"><span data-stu-id="862cb-209">Managed Threading Basics</span></span>](managed-threading-basics.md)
